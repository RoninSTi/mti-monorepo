# Requirements Archive: v1.0 Database + API Layer

**Archived:** 2026-02-08
**Status:** ✅ SHIPPED

This is the archived requirements specification for v1.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

# Requirements: Milestone v1.0 Factory and Gateway CRUD

**Defined:** 2026-02-08
**Core Value:** Build a reliable foundation for multi-gateway factory monitoring: persistent data model, REST API, and connection orchestration

## v1.0 Requirements

Requirements for Milestone v1.0: Database + API Layer (Phases 7-11). Multi-gateway orchestration deferred to next milestone.

### Database & Migrations

- [x] **DB-01**: PostgreSQL runs via Docker Compose
- [x] **DB-02**: Migrations create organizations, factories, gateways tables with correct schema
- [x] **DB-03**: UUID primary keys, soft deletes (deleted_at), JSONB metadata columns
- [x] **DB-04**: Indexes on foreign keys and query-heavy columns
- [x] **DB-05**: Foreign key constraints for data integrity

### Repository Layer

- [x] **REPO-01**: Database connection pool configured with Kysely
- [x] **REPO-02**: Type definitions generated from schema
- [x] **REPO-03**: FactoryRepository (create, findById, findAll, update, softDelete)
- [x] **REPO-04**: GatewayRepository (create, findById, findAll, findActive, update, softDelete)
- [x] **REPO-05**: Soft delete queries exclude deleted records (WHERE deleted_at IS NULL)
- [x] **REPO-06**: Repository methods return correctly typed results

### Encryption

- [x] **CRYPTO-01**: Encrypt gateway passwords before database storage (AES-256-GCM)
- [x] **CRYPTO-02**: Decrypt passwords when needed for connections
- [x] **CRYPTO-03**: Encryption key loaded from environment variable
- [x] **CRYPTO-04**: Encryption/decryption round-trips successfully

### API Server Foundation

- [x] **API-01**: Fastify server starts on configured port (default: 3000)
- [x] **API-02**: Health check endpoint (GET /api/health) returns 200 OK
- [x] **API-03**: CORS headers present (@fastify/cors)
- [x] **API-04**: Security headers present (@fastify/helmet)
- [x] **API-05**: Zod validation plugin registered (@fastify/type-provider-zod)
- [x] **API-06**: Standardized error responses (code, message, details)
- [x] **API-07**: Request logging middleware configured

### Factory CRUD

- [x] **FACTORY-01**: Create factory (POST /api/factories)
- [x] **FACTORY-02**: List factories (GET /api/factories with pagination)
- [x] **FACTORY-03**: Get factory by ID (GET /api/factories/:id)
- [x] **FACTORY-04**: Update factory (PUT /api/factories/:id)
- [x] **FACTORY-05**: Soft delete factory (DELETE /api/factories/:id)
- [x] **FACTORY-06**: Deleted factories excluded from default queries
- [x] **FACTORY-07**: Invalid requests return 400 with validation details
- [x] **FACTORY-08**: Missing resources return 404
- [x] **FACTORY-09**: Zod schemas for factory requests/responses

### Gateway CRUD

- [x] **GATEWAY-01**: Create gateway (POST /api/gateways, encrypt password)
- [x] **GATEWAY-02**: List gateways (GET /api/gateways with pagination, filter by factory)
- [x] **GATEWAY-03**: Get gateway by ID (GET /api/gateways/:id)
- [x] **GATEWAY-04**: Update gateway (PUT /api/gateways/:id, re-encrypt if password changed)
- [x] **GATEWAY-05**: Soft delete gateway (DELETE /api/gateways/:id)
- [x] **GATEWAY-06**: Passwords are encrypted in database (not plaintext)
- [x] **GATEWAY-07**: Cannot retrieve plaintext passwords via API
- [x] **GATEWAY-08**: Database errors return 500 with safe error messages
- [x] **GATEWAY-09**: Zod schemas for gateway requests/responses

### Code Quality

- [x] **QUAL-01**: Modular architecture (api/, database/, gateway-manager/ directories)
- [x] **QUAL-02**: All database queries use Kysely (type-safe)
- [x] **QUAL-03**: All API requests validated with Zod
- [x] **QUAL-04**: Error handling follows consistent patterns
- [x] **QUAL-05**: Logging provides actionable information
- [x] **QUAL-06**: Configuration externalized (environment variables)
- [x] **QUAL-07**: README documents setup and usage
- [x] **QUAL-08**: TypeScript strict mode enabled

## v1.1 Requirements

Deferred to next milestone (after Milestone 0 Phase 6 complete).

### Multi-Gateway Orchestration

- **ORCH-01**: GatewayConnectionManager orchestrates multiple WebSocketConnection instances
- **ORCH-02**: GatewayRegistry tracks in-memory connection state
- **ORCH-03**: Load active gateways from database on startup
- **ORCH-04**: Connect all gateways in parallel
- **ORCH-05**: Can manage 3+ gateways concurrently without interference
- **ORCH-06**: Each gateway is independent failure domain (one failure doesn't cascade)

### Gateway Lifecycle Management

- **LIFECYCLE-01**: Creating gateway via API triggers automatic connection
- **LIFECYCLE-02**: Updating gateway URL/credentials triggers reconnection
- **LIFECYCLE-03**: Deleting gateway disconnects cleanly and removes from registry
- **LIFECYCLE-04**: Application restart loads all active gateways
- **LIFECYCLE-05**: All gateways reconnect automatically on startup

### Connection Status Monitoring

- **STATUS-01**: GET /api/gateways/:id/status returns accurate real-time state
- **STATUS-02**: POST /api/gateways/:id/connect triggers connection
- **STATUS-03**: POST /api/gateways/:id/disconnect triggers disconnection
- **STATUS-04**: Connection state tracked accurately in GatewayRegistry
- **STATUS-05**: Update last_seen_at on successful connections

## Out of Scope

Explicitly excluded from v1.0 and v1.1:

| Feature | Reason |
|---------|--------|
| Sensor assignment to equipment | Milestone 2 - requires gateway orchestration working first |
| Acquisition scheduling | Milestone 3 - requires sensor assignment |
| Waveform data persistence | Milestone 3 - requires acquisition working |
| Web UI | Future milestone - API-first approach |
| API authentication (JWT/OAuth) | Future security milestone - focus on functionality first |
| Multi-tenancy enforcement | Schema supports it, but single org sufficient for now |
| Advanced monitoring (metrics, dashboards) | Future operational milestone |
| Load balancing | Single API instance sufficient for now |
| Database replication | Single database instance sufficient for now |

## Traceability

Which phases cover which requirements. Final status as of milestone completion.

| Requirement | Phase | Status |
|-------------|-------|--------|
| DB-01 | Phase 7 | ✅ Complete |
| DB-02 | Phase 7 | ✅ Complete |
| DB-03 | Phase 7 | ✅ Complete |
| DB-04 | Phase 7 | ✅ Complete |
| DB-05 | Phase 7 | ✅ Complete |
| REPO-01 | Phase 8 | ✅ Complete |
| REPO-02 | Phase 8 | ✅ Complete |
| REPO-03 | Phase 8 | ✅ Complete |
| REPO-04 | Phase 8 | ✅ Complete |
| REPO-05 | Phase 8 | ✅ Complete |
| REPO-06 | Phase 8 | ✅ Complete |
| CRYPTO-01 | Phase 8 | ✅ Complete |
| CRYPTO-02 | Phase 8 | ✅ Complete |
| CRYPTO-03 | Phase 8 | ✅ Complete |
| CRYPTO-04 | Phase 8 | ✅ Complete |
| API-01 | Phase 9 | ✅ Complete |
| API-02 | Phase 9 | ✅ Complete |
| API-03 | Phase 9 | ✅ Complete |
| API-04 | Phase 9 | ✅ Complete |
| API-05 | Phase 9 | ✅ Complete |
| API-06 | Phase 9 | ✅ Complete |
| API-07 | Phase 9 | ✅ Complete |
| FACTORY-01 | Phase 10 | ✅ Complete |
| FACTORY-02 | Phase 10 | ✅ Complete |
| FACTORY-03 | Phase 10 | ✅ Complete |
| FACTORY-04 | Phase 10 | ✅ Complete |
| FACTORY-05 | Phase 10 | ✅ Complete |
| FACTORY-06 | Phase 10 | ✅ Complete |
| FACTORY-07 | Phase 10 | ✅ Complete |
| FACTORY-08 | Phase 10 | ✅ Complete |
| FACTORY-09 | Phase 10 | ✅ Complete |
| GATEWAY-01 | Phase 11 | ✅ Complete |
| GATEWAY-02 | Phase 11 | ✅ Complete |
| GATEWAY-03 | Phase 11 | ✅ Complete |
| GATEWAY-04 | Phase 11 | ✅ Complete |
| GATEWAY-05 | Phase 11 | ✅ Complete |
| GATEWAY-06 | Phase 11 | ✅ Complete |
| GATEWAY-07 | Phase 11 | ✅ Complete |
| GATEWAY-08 | Phase 11 | ✅ Complete |
| GATEWAY-09 | Phase 11 | ✅ Complete |
| QUAL-01 | Phase 9 | ✅ Complete |
| QUAL-02 | Phase 8 | ✅ Complete |
| QUAL-03 | Phase 9 | ✅ Complete |
| QUAL-04 | Phase 9 | ✅ Complete |
| QUAL-05 | Phase 9 | ✅ Complete |
| QUAL-06 | Phase 9 | ✅ Complete |
| QUAL-07 | Phase 11 | ✅ Complete |
| QUAL-08 | Phase 8 | ✅ Complete |

**Coverage:**
- v1.0 requirements: 46 total
- Shipped: 46 (100%)
- Unmapped: 0 ✓

---

## Milestone Summary

**Shipped:** 46 of 46 v1.0 requirements (100%)

**Adjusted During Implementation:**
- None - all requirements shipped as originally defined

**Dropped Requirements:**
- None - all requirements validated and delivered

**Key Outcomes:**
- Database layer: PostgreSQL with UUID PKs, soft deletes, JSONB metadata
- Repository layer: Type-safe Kysely with AES-256-GCM encryption
- API layer: Fastify with Zod validation, CORS/Helmet security
- CRUD operations: Complete factory and gateway management
- UAT: 10/10 tests passed, 0 issues

**Next Milestone (v1.1):**
- Multi-gateway orchestration (ORCH-01 through ORCH-06)
- Gateway lifecycle management (LIFECYCLE-01 through LIFECYCLE-05)
- Connection status monitoring (STATUS-01 through STATUS-05)

---
*Requirements defined: 2026-02-08*
*Archived: 2026-02-08 as part of v1.0 milestone completion*
