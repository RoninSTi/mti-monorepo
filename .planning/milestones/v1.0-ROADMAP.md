# Milestone v1.0: Database + API Layer

**Status:** ✅ SHIPPED 2026-02-08
**Phases:** 7-11
**Total Plans:** 11

## Overview

Establish production-ready persistence and REST API for managing factories and gateways with encrypted credential storage. This milestone delivers the foundational data layer and API server without multi-gateway orchestration (deferred to v1.1).

**Target Features (All Delivered):**
- PostgreSQL database with organizations, factories, gateways tables
- Type-safe repository layer with Kysely query builder
- REST API with Fastify (Factory CRUD + Gateway CRUD endpoints)
- Encrypted gateway credential storage (AES-256-GCM)
- Request validation with Zod schemas
- Standardized error responses

## Phases

### Phase 7: Database Setup

**Goal**: PostgreSQL database running with complete schema and migrations
**Depends on**: Phase 6 (Milestone 0)
**Requirements**: DB-01, DB-02, DB-03, DB-04, DB-05
**Success Criteria** (what must be TRUE):
  1. PostgreSQL runs via Docker Compose on configured port
  2. Migrations apply successfully and create all three tables (organizations, factories, gateways)
  3. All tables have UUID primary keys, soft delete columns (deleted_at), and JSONB metadata
  4. Foreign key constraints enforce data integrity (factories reference organizations, gateways reference factories)
  5. Indexes exist on foreign keys and query-heavy columns for performance

Plans:
- [x] 07-01-PLAN.md -- Docker Compose, database config, npm scripts, dependency installation
- [x] 07-02-PLAN.md -- Migration files (organizations, factories, gateways), seed data, reset script

**Details:**
- PostgreSQL 15 via Docker Compose with health checks
- Three tables created: organizations, factories, gateways
- UUID primary keys with gen_random_uuid()
- Soft delete pattern with deleted_at column (nullable timestamptz)
- JSONB metadata columns for flexible data storage
- Foreign key CASCADE constraints (factories→organizations, gateways→factories)
- Indexes on FK columns, partial indexes on deleted_at (WHERE deleted_at IS NULL)
- Name indexes for search queries
- Automatic updated_at via PostgreSQL trigger (update_updated_at_column)
- Seed data: 1 organization, 3 factories, 6 gateways
- npm scripts for db:migrate, db:seed, db:reset, docker:up/down/reset

---

### Phase 8: Repository Layer

**Goal**: Type-safe data access layer with encryption for sensitive credentials
**Depends on**: Phase 7
**Requirements**: REPO-01, REPO-02, REPO-03, REPO-04, REPO-05, REPO-06, CRYPTO-01, CRYPTO-02, CRYPTO-03, CRYPTO-04, QUAL-02, QUAL-08
**Success Criteria** (what must be TRUE):
  1. Kysely connection pool connects to PostgreSQL and generates type-safe query builders
  2. FactoryRepository provides create, findById, findAll, update, and softDelete methods
  3. GatewayRepository provides create, findById, findAll, findActive, update, and softDelete methods
  4. Soft delete queries automatically exclude deleted records (WHERE deleted_at IS NULL)
  5. Gateway passwords are encrypted before storage using AES-256-GCM and decrypt successfully for connections
  6. All repository methods return correctly typed results

Plans:
- [x] 08-01-PLAN.md -- Kysely connection pool, type generation (kysely-codegen), Zod validation schemas
- [x] 08-02-PLAN.md -- AES-256-GCM encryption utilities (TDD)
- [x] 08-03-PLAN.md -- FactoryRepository, GatewayRepository, seed data encryption

**Details:**
- Kysely query builder singleton with PostgreSQL dialect
- Generated TypeScript types via kysely-codegen (automatic on db:migrate)
- FactoryRepository: 6 methods (create, findById, findAll, findByOrganization, update, softDelete)
- GatewayRepository: 8 methods (create, findById, findAll, findActive, update, updatePassword, softDelete, getDecryptedPassword)
- Soft delete filtering: WHERE deleted_at IS NULL in all SELECT/UPDATE queries (11 instances)
- AES-256-GCM encryption with random IV per encryption (never reuse IV)
- ENCRYPTION_KEY environment variable (32-byte base64 key)
- 18 encryption tests passing (round-trip, uniqueness, validation, tamper detection)
- Repository singleton exports for API layer consumption

---

### Phase 9: API Server Foundation

**Goal**: Fastify server running with health check, validation, and error handling
**Depends on**: Phase 8
**Requirements**: API-01, API-02, API-03, API-04, API-05, API-06, API-07, QUAL-01, QUAL-03, QUAL-04, QUAL-05, QUAL-06
**Success Criteria** (what must be TRUE):
  1. Fastify server starts on configured port (default 3000) and responds to requests
  2. Health check endpoint (GET /api/health) returns 200 OK with status information
  3. CORS headers are present on all responses for configured origins
  4. Security headers are present via Helmet middleware
  5. Zod validation plugin rejects invalid requests with detailed error messages
  6. All errors return standardized JSON format with error code, message, and details
  7. Request logging provides actionable information (method, path, status, duration)

Plans:
- [x] 09-01-PLAN.md -- Fastify app factory with Zod validation, CORS, Helmet, error handler
- [x] 09-02-PLAN.md -- Health check endpoint, server entry point, npm scripts, graceful shutdown

**Details:**
- Fastify 5.x with TypeScript-first Zod type provider
- App factory pattern (buildApp) for testability
- Plugin registration order: CORS → Helmet → Zod validators → Error handler → Routes
- Health check endpoint: GET /api/health (returns status, timestamp, uptime, version)
- CORS plugin with environment-based origin handling
- Helmet security headers (CSP disabled for API-only server)
- Standardized error responses: { error: { code, message, statusCode, details? } }
- Pino logger with environment-based configuration (pretty-print in dev, JSON in prod)
- Graceful shutdown with database cleanup (SIGINT/SIGTERM handlers)
- npm scripts: dev:api (tsx with hot reload), start:api (production)

---

### Phase 10: Factory API

**Goal**: Complete CRUD operations for factory management via REST endpoints
**Depends on**: Phase 9
**Requirements**: FACTORY-01, FACTORY-02, FACTORY-03, FACTORY-04, FACTORY-05, FACTORY-06, FACTORY-07, FACTORY-08, FACTORY-09
**Success Criteria** (what must be TRUE):
  1. User can create factories via POST /api/factories with validated input
  2. User can list all factories via GET /api/factories with pagination support
  3. User can retrieve a single factory by ID via GET /api/factories/:id
  4. User can update factory details via PUT /api/factories/:id
  5. User can soft delete factories via DELETE /api/factories/:id (deleted factories excluded from default queries)
  6. Invalid requests return 400 with Zod validation details
  7. Missing factories return 404 with appropriate error message

Plans:
- [x] 10-01-PLAN.md -- Zod schemas for factory API and FactoryRepository pagination support
- [x] 10-02-PLAN.md -- Factory CRUD route handlers and app.ts registration

**Details:**
- Five RESTful endpoints: POST, GET, GET/:id, PUT, DELETE /api/factories
- Pagination support: limit (1-100, default 20), offset (default 0), hasNext/hasPrev metadata
- Zod schemas: createFactorySchema, updateFactorySchema, factoryResponseSchema, factoryListResponseSchema
- toFactoryResponse helper converts dates to ISO strings, excludes deleted_at
- Parallel data/count fetch for efficient pagination
- Validation: organization_id (uuid), name (1-255 chars), location (optional), timezone (default UTC)
- Error codes: FACTORY_NOT_FOUND, VALIDATION_ERROR
- Status codes: 201 (created), 200 (success), 404 (not found), 204 (deleted)

---

### Phase 11: Gateway API CRUD

**Goal**: Complete CRUD operations for gateway management with encrypted credential storage
**Depends on**: Phase 10
**Requirements**: GATEWAY-01, GATEWAY-02, GATEWAY-03, GATEWAY-04, GATEWAY-05, GATEWAY-06, GATEWAY-07, GATEWAY-08, GATEWAY-09, QUAL-07
**Success Criteria** (what must be TRUE):
  1. User can create gateways via POST /api/gateways with automatic password encryption
  2. User can list gateways via GET /api/gateways with pagination and factory filtering
  3. User can retrieve a single gateway by ID via GET /api/gateways/:id
  4. User can update gateway details via PUT /api/gateways/:id (password re-encrypted if changed)
  5. User can soft delete gateways via DELETE /api/gateways/:id
  6. Gateway passwords are never returned in plaintext via API responses
  7. Database errors return 500 with safe error messages (no credential leakage)
  8. README documents setup, configuration, and API usage

Plans:
- [x] 11-01-PLAN.md -- Gateway Zod schemas (password handling) and GatewayRepository pagination
- [x] 11-02-PLAN.md -- Gateway CRUD routes, app.ts registration, and README documentation

**Details:**
- Five RESTful endpoints: POST, GET, GET/:id, PUT, DELETE /api/gateways
- Factory filtering: GET /api/gateways?factory_id=uuid
- Password encryption transparent: plaintext in request → AES-256-GCM → stored → never returned
- Zod schemas: createGatewaySchema (with plaintext password), updateGatewaySchema, gatewayResponseSchema (excludes password fields)
- toGatewayResponse helper explicitly excludes password and password_encrypted
- Separate password updates: updatePassword() vs update() for clear encryption path
- Validation: factory_id (uuid, FK), gateway_id (unique), name, url, email, password, model, firmware_version
- README: 214 lines documenting setup (7 steps), environment variables, npm scripts, API endpoints, security notes
- UAT: 10/10 tests passed (create, list, filter, get, update, update password, delete, validation, errors, docs)

---

## Milestone Summary

**Accomplishments:**

1. **Production-ready database schema** with UUID PKs, soft deletes, JSONB metadata, CASCADE constraints
2. **Type-safe repository layer** with Kysely query builder and AES-256-GCM encryption
3. **Complete REST API** with 11 endpoints (health + factory CRUD + gateway CRUD)
4. **Strong security** with encrypted credentials, safe error messages, CORS/Helmet
5. **Comprehensive documentation** with README and UAT validation

**Key Decisions:**

| Decision | Rationale | Outcome |
|----------|-----------|---------|
| PostgreSQL over MongoDB | Relational model + JSONB flexibility + TypeScript ecosystem | ✓ Good — Strong type generation |
| Kysely over ORM | Type-safe SQL without magic, explicit queries | ✓ Good — No hidden behavior |
| Fastify over Express | TypeScript-first, high performance, built-in validation | ✓ Good — Excellent DX |
| Encrypt (not hash) passwords | Need plaintext to authenticate with gateways | ✓ Good — Security maintained |
| Soft deletes | Preserve audit trail, avoid cascading hard deletes | ✓ Good — Data recovery possible |
| Split API-first then orchestration | Can progress while M0 Phase 6 pending | ✓ Good — Unblocked development |

**Issues Resolved:**

- Database schema design (UUID vs auto-increment → UUIDs for distributed systems)
- Password storage (encrypt vs hash → encrypt for gateway authentication)
- Pagination efficiency (N+1 queries → parallel data/count fetch)
- Type safety (JsonValue mismatch → documented workaround with casting)

**Issues Deferred:**

- Multi-gateway connection orchestration (Milestone v1.1)
- Gateway lifecycle management (Milestone v1.1)
- Real-time connection status monitoring (Milestone v1.1)
- API authentication (JWT/OAuth) (Future security milestone)
- Sensor assignment to equipment (Milestone 2)

**Technical Debt Incurred:**

None. Minor observations (not debt):
- Type casting for metadata field (JsonValue → Record<string, unknown>) — acceptable workaround
- Manual pagination for findActive() — optimize when data volume increases

**Milestone Stats:**

- **Duration:** 1 day (2026-02-07 → 2026-02-08)
- **Files:** 59 files created/modified
- **Lines of code:** 3,988 TypeScript
- **Phases:** 5 phases (7-11)
- **Plans:** 11 plans
- **Requirements:** 46/46 satisfied (100%)
- **UAT:** 10/10 tests passed

---

_For current project status, see .planning/ROADMAP.md (created for next milestone)_
_For archived requirements, see .planning/milestones/v1.0-REQUIREMENTS.md_
_For milestone audit, see .planning/milestones/v1.0-MILESTONE-AUDIT.md_
