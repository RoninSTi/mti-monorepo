---
phase: 08-repository-layer
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/repositories/FactoryRepository.ts
  - src/repositories/GatewayRepository.ts
  - src/database/seed.ts
autonomous: true

must_haves:
  truths:
    - "FactoryRepository provides create, findById, findAll, update, and softDelete methods"
    - "GatewayRepository provides create, findById, findAll, findActive, update, and softDelete methods"
    - "All SELECT queries exclude soft-deleted records by default (WHERE deleted_at IS NULL)"
    - "Gateway passwords are encrypted with AES-256-GCM before database storage"
    - "Gateway passwords can be decrypted for connections"
    - "All repository methods return correctly typed results matching Kysely Selectable types"
    - "Seed data uses real encryption instead of placeholder passwords"
  artifacts:
    - path: "src/repositories/FactoryRepository.ts"
      provides: "Type-safe factory CRUD with soft delete"
      exports: ["factoryRepository"]
    - path: "src/repositories/GatewayRepository.ts"
      provides: "Type-safe gateway CRUD with soft delete and encryption"
      exports: ["gatewayRepository"]
    - path: "src/database/seed.ts"
      provides: "Seed data with real encrypted gateway passwords"
      contains: "encryptPassword"
  key_links:
    - from: "src/repositories/FactoryRepository.ts"
      to: "src/database/kysely.ts"
      via: "imports db for query execution"
      pattern: "import.*db.*kysely"
    - from: "src/repositories/FactoryRepository.ts"
      to: "src/repositories/types.ts"
      via: "imports Factory, NewFactory, FactoryUpdate type aliases"
      pattern: "import.*Factory.*types"
    - from: "src/repositories/GatewayRepository.ts"
      to: "src/utils/encryption.ts"
      via: "imports encryptPassword and decryptPassword for gateway credentials"
      pattern: "import.*encrypt.*encryption"
    - from: "src/repositories/GatewayRepository.ts"
      to: "src/database/kysely.ts"
      via: "imports db for query execution"
      pattern: "import.*db.*kysely"
    - from: "src/database/seed.ts"
      to: "src/utils/encryption.ts"
      via: "uses encryptPassword for seed gateway passwords"
      pattern: "import.*encryptPassword.*encryption"
---

<objective>
Create FactoryRepository and GatewayRepository with type-safe CRUD operations, soft delete filtering, and encrypted credential storage. Update seed data to use real encryption.

Purpose: These repositories are the data access layer that API endpoints (Phases 10-11) will use. They encapsulate all database queries, enforce soft delete filtering, and handle gateway password encryption transparently.

Output: Two repository modules with singleton exports, updated seed script with real encryption.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-repository-layer/08-RESEARCH.md
@.planning/phases/08-repository-layer/08-01-SUMMARY.md
@.planning/phases/08-repository-layer/08-02-SUMMARY.md
@src/database/kysely.ts
@src/database/types.ts
@src/repositories/types.ts
@src/utils/encryption.ts
@src/database/seed.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FactoryRepository and GatewayRepository</name>
  <files>
    src/repositories/FactoryRepository.ts
    src/repositories/GatewayRepository.ts
  </files>
  <action>
Create `src/repositories/FactoryRepository.ts` - standalone repository class:
- Import `db` from '../database/kysely'
- Import `Factory`, `NewFactory`, `FactoryUpdate` from './types'
- Create `FactoryRepository` class with these methods:
  - `findById(id: string): Promise<Factory | undefined>` - SELECT where id matches AND deleted_at IS NULL
  - `findAll(): Promise<Factory[]>` - SELECT all where deleted_at IS NULL, ordered by name ASC
  - `findByOrganization(organizationId: string): Promise<Factory[]>` - SELECT by org_id, deleted_at IS NULL, ordered by name ASC
  - `create(factory: NewFactory): Promise<Factory>` - INSERT with returningAll, executeTakeFirstOrThrow
  - `update(id: string, updates: FactoryUpdate): Promise<Factory | undefined>` - UPDATE with set({...updates, updated_at: new Date()}), where id AND deleted_at IS NULL, returningAll, executeTakeFirst
  - `softDelete(id: string): Promise<Factory | undefined>` - UPDATE set deleted_at to new Date(), where id AND deleted_at IS NULL (prevents double-delete), returningAll, executeTakeFirst
- Export singleton instance: `export const factoryRepository = new FactoryRepository()`

CRITICAL: Every SELECT and UPDATE query MUST include `.where('deleted_at', 'is', null)` to enforce soft delete filtering.

Create `src/repositories/GatewayRepository.ts` - standalone repository class:
- Import `db` from '../database/kysely'
- Import `Gateway`, `NewGateway`, `GatewayUpdate` from './types'
- Import `encryptPassword`, `decryptPassword`, `getEncryptionKey`, `EncryptedData` from '../utils/encryption'
- Create `GatewayRepository` class:
  - Private `encryptionKey: Buffer` field, initialized in constructor via `getEncryptionKey()`
  - `findById(id: string): Promise<Gateway | undefined>` - SELECT where id AND deleted_at IS NULL
  - `findAll(): Promise<Gateway[]>` - SELECT all where deleted_at IS NULL, ordered by name ASC
  - `findActive(factoryId: string): Promise<Gateway[]>` - SELECT where factory_id matches AND deleted_at IS NULL, ordered by name ASC
  - `create(input: GatewayCreateInput): Promise<Gateway>` - Accept plaintext password in input, encrypt with encryptPassword(), store as JSON.stringify(encrypted) in password_encrypted column, INSERT with returningAll
  - `update(id: string, updates: GatewayUpdate): Promise<Gateway | undefined>` - UPDATE with set({...updates, updated_at: new Date()}), where id AND deleted_at IS NULL, returningAll
  - `updatePassword(id: string, newPassword: string): Promise<Gateway | undefined>` - Encrypt new password, UPDATE password_encrypted and updated_at, where id AND deleted_at IS NULL
  - `softDelete(id: string): Promise<Gateway | undefined>` - UPDATE set deleted_at, where id AND deleted_at IS NULL, returningAll
  - `getDecryptedPassword(gateway: Gateway): string` - Parse password_encrypted JSON, decrypt with decryptPassword(), return plaintext

Define `GatewayCreateInput` interface in this file:
```typescript
interface GatewayCreateInput {
  factory_id: string;
  gateway_id: string;
  name: string;
  url: string;
  email: string;
  password: string; // Plaintext - will be encrypted
  model?: string;
  firmware_version?: string;
  metadata?: Record<string, unknown>;
}
```

Export singleton: `export const gatewayRepository = new GatewayRepository()`

Note: The singleton export means ENCRYPTION_KEY must be set when the module loads. This is appropriate -- the application should fail fast at startup if encryption is not configured.
  </action>
  <verify>
1. `npm run build` compiles without errors
2. FactoryRepository exports: factoryRepository with findById, findAll, findByOrganization, create, update, softDelete
3. GatewayRepository exports: gatewayRepository with findById, findAll, findActive, create, update, updatePassword, softDelete, getDecryptedPassword
4. Every query method includes `.where('deleted_at', 'is', null)` (grep for verification)
  </verify>
  <done>Both repositories compile with type-safe Kysely queries, all methods enforce soft delete filtering, gateway create encrypts passwords, singleton instances exported</done>
</task>

<task type="auto">
  <name>Task 2: Update seed data to use real encryption</name>
  <files>
    src/database/seed.ts
  </files>
  <action>
Update `src/database/seed.ts` to replace the placeholder password with real AES-256-GCM encryption:

1. Add imports at top:
   - Import `encryptPassword`, `getEncryptionKey` from '../utils/encryption'

2. At the start of the seed() function (before any database operations):
   - Call `getEncryptionKey()` to get the encryption key Buffer
   - Encrypt a seed password (e.g., "admin123") using `encryptPassword('admin123', key)`
   - Convert to JSON string: `JSON.stringify(encrypted)` -- this is what gets stored in password_encrypted column

3. Replace `const placeholderPassword = 'PLACEHOLDER_ENCRYPTED_PASSWORD'` with the real encrypted JSON string

4. The rest of the seed script remains the same -- it already inserts the password value into the password_encrypted column

5. Add a comment explaining:
   ```
   // Encrypt seed password with AES-256-GCM
   // Requires ENCRYPTION_KEY environment variable to be set
   // Generate key with: openssl rand -base64 32
   ```

Also add ENCRYPTION_KEY to the .env.example if not already there, and generate a development-only key for local testing. Add a clear comment that this key is for development only.

**Important:** The seed script runs via `npm run db:seed` which uses `--env-file=.env`. The user must have ENCRYPTION_KEY in their .env file for seeding to work. This is documented in .env.example.
  </action>
  <verify>
1. `npm run build` compiles without errors
2. Seed script no longer references 'PLACEHOLDER_ENCRYPTED_PASSWORD'
3. Seed script imports and uses encryptPassword from utils/encryption
4. With ENCRYPTION_KEY set, `npm run db:seed` completes successfully
5. Query gateways table to confirm password_encrypted contains valid JSON with encrypted, iv, authTag fields
  </verify>
  <done>Seed data uses real AES-256-GCM encryption for gateway passwords, placeholder removed, seed script validates encryption key on startup</done>
</task>

</tasks>

<verification>
1. `npm run build` compiles without errors
2. FactoryRepository has: create, findById, findAll, findByOrganization, update, softDelete
3. GatewayRepository has: create, findById, findAll, findActive, update, updatePassword, softDelete, getDecryptedPassword
4. All repository queries include `deleted_at IS NULL` filter (grep -r "deleted_at.*is.*null" src/repositories/)
5. Gateway create encrypts password before storage
6. Gateway getDecryptedPassword recovers plaintext
7. Seed data produces valid encrypted passwords in database
8. Types align: repository methods return Factory/Gateway types from generated Kysely types
</verification>

<success_criteria>
- FactoryRepository provides create, findById, findAll, update, softDelete with typed results
- GatewayRepository provides create, findById, findAll, findActive, update, softDelete with typed results
- Soft delete queries exclude deleted records (WHERE deleted_at IS NULL) in every method
- Gateway passwords encrypted with AES-256-GCM before storage
- Gateway passwords decryptable for connections via getDecryptedPassword
- Seed data uses real encryption (no more placeholder)
- npm run build passes
</success_criteria>

<output>
After completion, create `.planning/phases/08-repository-layer/08-03-SUMMARY.md`
</output>
