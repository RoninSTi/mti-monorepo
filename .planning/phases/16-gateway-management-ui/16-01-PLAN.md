---
phase: 16-gateway-management-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/pages/GatewaysPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of all gateways with factory name, gateway ID, name, URL, email, model, firmware"
    - "User can filter gateway list by factory using dropdown selector"
    - "User can create new gateway through form with factory select, all required fields, and password"
    - "User can edit gateway details with password field blank by default, only updating password if filled"
    - "User can delete gateway after confirming in modal dialog showing gateway name"
    - "All operations show success/error toast notifications"
    - "Loading spinner shows during initial data fetch, buttons disabled during mutations"
  artifacts:
    - path: "frontend/src/pages/GatewaysPage.tsx"
      provides: "Complete gateway management page with CRUD, factory filtering, and password security"
      min_lines: 200
  key_links:
    - from: "frontend/src/pages/GatewaysPage.tsx"
      to: "@/hooks/useGateways"
      via: "import useGateways, useCreateGateway, useUpdateGateway, useDeleteGateway"
      pattern: "useGateways|useCreateGateway|useUpdateGateway|useDeleteGateway"
    - from: "frontend/src/pages/GatewaysPage.tsx"
      to: "@/hooks/useFactories"
      via: "import useFactories for factory name lookup and filter dropdown"
      pattern: "useFactories"
    - from: "frontend/src/pages/GatewaysPage.tsx"
      to: "@/components/forms/GatewayForm"
      via: "import GatewayForm with mode prop for create/edit dialogs"
      pattern: "GatewayForm"
    - from: "frontend/src/pages/GatewaysPage.tsx"
      to: "sonner"
      via: "import toast for success/error notifications"
      pattern: "toast\\.success|toast\\.error"
---

<objective>
Implement the complete GatewaysPage with full CRUD operations, factory filtering dropdown, client-side factory name lookup, and secure password handling.

Purpose: This is the gateway management interface -- the core of v1.1. Vibration analysts use this page to configure gateway connections (URL, credentials, factory assignment) for each monitoring device. The page replicates the proven FactoriesPage CRUD pattern (Phase 15-02) with three gateway-specific extensions: password security in edit mode, factory filtering dropdown, and factory name display via client-side lookup.

Output: A fully functional GatewaysPage.tsx replacing the existing placeholder, satisfying all GATEWAY-UI requirements (01 through 07).
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-factory-management-ui/15-02-SUMMARY.md

Key source files to reference (clone patterns from these):
@frontend/src/pages/FactoriesPage.tsx
@frontend/src/components/forms/GatewayForm.tsx
@frontend/src/hooks/useGateways.ts
@frontend/src/hooks/useFactories.ts
@frontend/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement GatewaysPage with full CRUD operations and factory name lookup</name>
  <files>frontend/src/pages/GatewaysPage.tsx</files>
  <action>
Replace the placeholder GatewaysPage with a complete gateway management page. Clone the structure from FactoriesPage.tsx exactly (same imports pattern, same state management, same handler pattern, same loading/error/empty states) with these gateway-specific adaptations:

**Imports:**
- Import useGateways, useCreateGateway, useUpdateGateway, useDeleteGateway from '@/hooks/useGateways'
- Import useFactories from '@/hooks/useFactories' (for factory name lookup AND filter dropdown)
- Import GatewayForm and types GatewayFormData, GatewayEditData from '@/components/forms/GatewayForm'
- Import Gateway, CreateGatewayInput from '@/types/api'
- Import same shadcn components as FactoriesPage (Button, Card/CardContent/CardDescription/CardHeader/CardTitle, Dialog/DialogContent/DialogDescription/DialogHeader/DialogTitle, AlertDialog full set, Table full set)
- Import toast from 'sonner', icons from 'lucide-react' (Pencil, Plus, Trash2, Loader2)
- Import Label from '@/components/ui/label' (for filter dropdown label)
- Import cn from '@/lib/utils' (for native select styling)

**State (page-level UI state only, per established pattern):**
- `isCreateDialogOpen: boolean` (useState, default false)
- `editingGateway: Gateway | null` (useState, default null)
- `deletingGateway: Gateway | null` (useState, default null) -- store full Gateway object so delete dialog can show gateway name
- `factoryFilter: string` (useState, default '') -- empty string means "all factories"

**Data fetching:**
- Compute gateway params: `const gatewayParams = factoryFilter ? { factory_id: factoryFilter } : undefined`
- `const { data: gatewayData, isLoading, isError, error } = useGateways(gatewayParams)` -- filter applied via query params
- `const { data: factoryData } = useFactories()` -- for filter dropdown population AND factory name lookup

**Factory name lookup helper:**
```typescript
const getFactoryName = (factory_id: string): string => {
  if (!factoryData?.data) return factory_id
  const factory = factoryData.data.find(f => f.id === factory_id)
  return factory?.name || factory_id
}
```
Fallback to factory_id (UUID) if factories not yet loaded or factory not found.

**Mutation hooks (identical pattern to FactoriesPage):**
- `const createGateway = useCreateGateway()`
- `const updateGateway = useUpdateGateway()`
- `const deleteGateway = useDeleteGateway()`

**Handler functions (toast try/catch pattern per Phase 15 decision):**

handleCreate: Cast formData to CreateGatewayInput (it already has factory_id from GatewayForm). Use `await createGateway.mutateAsync(formData as CreateGatewayInput)`. Toast success, close dialog. On catch: toast error, do NOT close dialog (allow retry).

handleUpdate: CRITICAL PASSWORD HANDLING -- Filter out empty password before sending to API. If `formData.password` is truthy, send full formData. If password is empty/undefined, spread formData and set password to undefined: `const updateData = formData.password ? formData : { ...formData, password: undefined }`. Then `await updateGateway.mutateAsync({ id: editingGateway!.id, data: updateData as UpdateGatewayInput })`. Toast success, set editingGateway to null. On catch: toast error, do NOT close dialog.

handleDelete: Same as FactoriesPage. `await deleteGateway.mutateAsync(deletingGateway!.id)`. Toast success, set deletingGateway to null. On catch: toast error, set deletingGateway to null (close dialog on delete errors per Phase 15 decision).

**Loading state (identical to FactoriesPage):**
- Centered Loader2 spinner with "Loading gateways..." text
- Same className pattern: `flex items-center justify-center h-64`

**Error state (identical to FactoriesPage):**
- Card with border-destructive, error message, "Try Again" button that calls `window.location.reload()`

**Safety check:** `if (!gatewayData) return null` after loading/error guards.

**Page header:**
- h1 "Gateways" with text-3xl font-bold
- Subtitle "Manage gateway connections" with text-muted-foreground
- "Add Gateway" button with Plus icon (opens create dialog)

**Factory filter dropdown (between header and table):**
- Container: `div className="flex items-center gap-4"`
- Label with htmlFor="factory-filter": "Filter by factory:"
- Native select element with id="factory-filter", styled with cn() using same classes as GatewayForm's factory_id select (flex h-9 w-[200px] rounded-md border border-input bg-background px-3 py-1 text-sm, focus-visible ring)
- value={factoryFilter}, onChange={(e) => setFactoryFilter(e.target.value)}
- First option: `<option value="">All Factories</option>`
- Map factoryData?.data sorted alphabetically by name: `[...(factoryData?.data || [])].sort((a, b) => a.name.localeCompare(b.name))` to produce option elements with value={factory.id} displaying factory.name
- Conditional "Clear filter" ghost button: only show when factoryFilter is truthy, onClick resets factoryFilter to ''

**Gateway table (inside Card, same as FactoriesPage):**
- CardHeader with CardTitle showing count: `{gatewayData.pagination.total} {gatewayData.pagination.total === 1 ? 'gateway' : 'gateways'}`
- Table columns: Factory, Gateway ID, Name, URL, Email, Model, Firmware, Actions (text-right)
- colSpan={8} for empty state

**Table rows:**
- Factory cell: `{getFactoryName(gateway.factory_id)}` with className="font-medium"
- Gateway ID cell: `{gateway.gateway_id}`
- Name cell: `{gateway.name}`
- URL cell: `{gateway.url}` with className="font-mono text-xs"
- Email cell: `{gateway.email}`
- Model cell: `{gateway.model || '\u2014'}` (em-dash for null)
- Firmware cell: `{gateway.firmware_version || '\u2014'}`
- Actions cell (text-right): Edit (Pencil icon, ghost button) and Delete (Trash2 icon, ghost button)

**Empty state (filter-aware):**
- When factoryFilter is set: "No gateways for this factory" / "Try selecting a different factory or clearing the filter."
- When no filter: "No gateways yet" / "Create your first gateway to get started."
- Always show "Add Gateway" CTA button with Plus icon and variant="outline"

**Create Dialog:**
- Dialog with open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}
- DialogTitle: "Create Gateway"
- DialogDescription: "Add a new gateway connection."
- GatewayForm with: factories={factoryData?.data || []}, mode="create", onSubmit={handleCreate}, isSubmitting={createGateway.isPending}, submitLabel="Create Gateway"

**Edit Dialog:**
- Dialog with open={!!editingGateway} onOpenChange={(open) => !open && setEditingGateway(null)}
- DialogTitle: "Edit Gateway"
- DialogDescription: "Update gateway connection details."
- GatewayForm with: factories={factoryData?.data || []}, mode="edit", onSubmit={handleUpdate}, isSubmitting={updateGateway.isPending}, submitLabel="Save Changes"
- defaultValues mapped from editingGateway: factory_id, gateway_id, name, url, email, password: '' (ALWAYS blank for security), model: editingGateway.model || '', firmware_version: editingGateway.firmware_version || ''

**Delete AlertDialog (identical structure to FactoriesPage):**
- AlertDialog with open={!!deletingGateway}, onOpenChange={(open) => !open && setDeletingGateway(null)
- Title: "Delete Gateway"
- Description: `Are you sure you want to delete "${deletingGateway?.name}"? This action cannot be undone.`
- Cancel button, Delete/Deleting... action button with destructive styling, disabled={deleteGateway.isPending}

**Critical implementation notes:**
- Do NOT add factory_id to GatewayForm types -- it already has it (Phase 13-03)
- Do NOT import or use DEFAULT_ORG_ID -- gateways don't need org ID, they reference factory_id directly
- Do NOT try to pre-populate password in edit mode -- Gateway type has no password field (GATEWAY-07 security)
- Import UpdateGatewayInput from '@/types/api' for the handleUpdate type cast
  </action>
  <verify>
Run `cd /Users/craigcronin/Development/mti-wifi-gsd/frontend && npx tsc --noEmit` to verify TypeScript compilation succeeds with zero errors.
Run `cd /Users/craigcronin/Development/mti-wifi-gsd/frontend && npm run build` to verify production build succeeds.
  </verify>
  <done>
GatewaysPage.tsx replaces placeholder with complete implementation:
- Gateway table displays with 8 columns (Factory name via lookup, Gateway ID, Name, URL, Email, Model, Firmware, Actions)
- Factory filter dropdown above table with "All Factories" option, alphabetically sorted factories, and clear button
- Create dialog with GatewayForm mode="create" (password required)
- Edit dialog with GatewayForm mode="edit" (password blank with placeholder, optional)
- handleUpdate strips empty password before sending to API
- Delete AlertDialog with gateway name interpolation
- Toast notifications on all CRUD operations (success and error)
- Loading spinner during initial fetch
- Mutation buttons disabled with loading text during operations
- Filter-aware empty state (different message when filter active vs no data at all)
- TypeScript compiles with zero errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify complete GATEWAY-UI requirement coverage</name>
  <files>frontend/src/pages/GatewaysPage.tsx</files>
  <action>
Read the completed GatewaysPage.tsx and verify all 7 GATEWAY-UI requirements are satisfied by checking for specific code patterns:

1. GATEWAY-UI-01 (gateway list with factory info): Verify Table component renders columns for Factory (via getFactoryName), Gateway ID, Name, URL, Email, Model, Firmware
2. GATEWAY-UI-02 (filter by factory): Verify factoryFilter useState, native select with "All Factories" option, gatewayParams passed to useGateways
3. GATEWAY-UI-03 (create form): Verify create Dialog with GatewayForm mode="create", factories prop, handleCreate handler
4. GATEWAY-UI-04 (edit form with optional password): Verify edit Dialog with GatewayForm mode="edit", defaultValues with password: '', handleUpdate strips empty password
5. GATEWAY-UI-05 (delete with confirmation): Verify AlertDialog with deletingGateway?.name interpolation, handleDelete handler
6. GATEWAY-UI-06 (success/error notifications): Verify toast.success and toast.error calls in all three handlers (handleCreate, handleUpdate, handleDelete)
7. GATEWAY-UI-07 (loading states): Verify isLoading spinner, isPending on all three mutation buttons

If any requirement is missing, fix it immediately. Then run the build one final time to confirm.
  </action>
  <verify>
Run `cd /Users/craigcronin/Development/mti-wifi-gsd/frontend && npm run build` to confirm production build passes.
Grep the file to confirm key patterns exist:
- `useGateways` (data fetching with filter)
- `useFactories` (factory name lookup)
- `getFactoryName` (client-side mapping)
- `mode="create"` and `mode="edit"` (GatewayForm modes)
- `password: ''` (blank password in edit defaults)
- `formData.password` (password filtering in handleUpdate)
- `toast.success` and `toast.error` (notifications)
- `isLoading` and `isPending` (loading states)
- `factoryFilter` (filter state)
- `AlertDialog` (delete confirmation)
  </verify>
  <done>
All 7 GATEWAY-UI requirements verified present in GatewaysPage.tsx. Production build passes. Phase 16 is complete.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/craigcronin/Development/mti-wifi-gsd/frontend && npx tsc --noEmit` -- TypeScript compilation with zero errors
2. `cd /Users/craigcronin/Development/mti-wifi-gsd/frontend && npm run build` -- Production build succeeds
3. Grep GatewaysPage.tsx for all required patterns: useGateways, useFactories, getFactoryName, GatewayForm, mode="create", mode="edit", password: '', toast.success, toast.error, isLoading, isPending, factoryFilter, AlertDialog
</verification>

<success_criteria>
- GatewaysPage.tsx is a complete CRUD page (not a placeholder) with 200+ lines
- Gateway table shows factory names (not UUIDs) via getFactoryName helper
- Factory filter dropdown filters gateways by factory_id using useGateways params
- Create dialog uses GatewayForm mode="create" with password required
- Edit dialog uses GatewayForm mode="edit" with password blank and optional
- handleUpdate strips empty password before sending to API (prevents encrypting empty string)
- Delete confirmation shows gateway name in AlertDialog
- All CRUD operations trigger toast notifications (success and error)
- Loading spinner on initial page load, disabled buttons during mutations
- Empty state is filter-aware (different messages when filter active)
- TypeScript compiles with zero errors
- Production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/16-gateway-management-ui/16-01-SUMMARY.md`
</output>
