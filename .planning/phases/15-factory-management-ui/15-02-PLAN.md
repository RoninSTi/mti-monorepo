---
phase: 15-factory-management-ui
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - frontend/src/pages/FactoriesPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can view list of all factories with name, location, timezone, and creation date"
    - "User can create new factory through form with inline validation errors"
    - "User can edit existing factory with form pre-populated with current values"
    - "User can delete factory after confirming in modal dialog"
    - "All operations show success/error toast notifications"
    - "Loading spinner displays while fetching factory list"
    - "Buttons show loading state and are disabled during mutation requests"
  artifacts:
    - path: "frontend/src/pages/FactoriesPage.tsx"
      provides: "Complete factory CRUD page with table, dialogs, toasts, and loading states"
      min_lines: 120
  key_links:
    - from: "frontend/src/pages/FactoriesPage.tsx"
      to: "frontend/src/hooks/useFactories.ts"
      via: "import useFactories, useCreateFactory, useUpdateFactory, useDeleteFactory"
      pattern: "useFactories|useCreateFactory|useUpdateFactory|useDeleteFactory"
    - from: "frontend/src/pages/FactoriesPage.tsx"
      to: "frontend/src/components/forms/FactoryForm.tsx"
      via: "import FactoryForm and render inside Dialog"
      pattern: "<FactoryForm"
    - from: "frontend/src/pages/FactoriesPage.tsx"
      to: "frontend/src/components/ui/alert-dialog.tsx"
      via: "import AlertDialog for delete confirmation"
      pattern: "<AlertDialog"
    - from: "frontend/src/pages/FactoriesPage.tsx"
      to: "sonner"
      via: "import toast from sonner for success/error notifications"
      pattern: "toast\\.(success|error)"
---

<objective>
Replace the FactoriesPage placeholder with a complete factory CRUD interface: data table listing all factories, create/edit forms in modal dialogs, delete confirmation with AlertDialog, Sonner toast notifications, and loading states.

Purpose: This is the core deliverable of Phase 15 -- the factory management UI that vibration analysts will use to add, edit, and remove factory locations. It composes all the pieces built in Phases 13-14 (form components, React Query hooks, shadcn/ui primitives) into a working page.

Output: A fully functional FactoriesPage.tsx that satisfies requirements FACTORY-UI-01 through FACTORY-UI-06.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-factory-management-ui/15-RESEARCH.md
@.planning/phases/15-factory-management-ui/15-01-SUMMARY.md
@frontend/src/pages/FactoriesPage.tsx
@frontend/src/hooks/useFactories.ts
@frontend/src/components/forms/FactoryForm.tsx
@frontend/src/types/api.ts
@frontend/src/components/ui/table.tsx
@frontend/src/components/ui/dialog.tsx
@frontend/src/components/ui/alert-dialog.tsx
@frontend/src/components/ui/card.tsx
@frontend/src/components/ui/button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement FactoriesPage with full CRUD operations</name>
  <files>frontend/src/pages/FactoriesPage.tsx</files>
  <action>
    Replace the placeholder FactoriesPage with a complete factory management page. This is a page-level orchestration component that composes existing hooks and components. Follow the Pattern 1 from 15-RESEARCH.md.

    **Imports needed:**
    - `useState` from react
    - `toast` from sonner
    - `Pencil, Plus, Trash2, Loader2` from lucide-react
    - `useFactories, useCreateFactory, useUpdateFactory, useDeleteFactory` from @/hooks/useFactories
    - `FactoryForm` and `FactoryFormData` from @/components/forms/FactoryForm
    - `Factory, CreateFactoryInput` from @/types/api
    - shadcn/ui: Button, Card, CardContent, CardDescription, CardHeader, CardTitle, Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, Table, TableBody, TableCell, TableHead, TableHeader, TableRow

    **Component state (UI state only -- React Query manages data state):**
    - `isCreateDialogOpen: boolean` - controls create dialog visibility
    - `editingFactory: Factory | null` - when non-null, edit dialog is open with this factory's data
    - `deletingFactory: Factory | null` - when non-null, delete confirmation dialog is open for this factory

    **Organization ID constant:**
    Define `const DEFAULT_ORG_ID = '00000000-0000-0000-0000-000000000001'` at module level. This is the v1.1 single-organization constant. Add a comment: `// v1.1: single organization -- replace with org selector when multi-tenancy is added`

    **Data fetching:**
    Call `useFactories()` with no params (fetch all, default limit). Destructure `{ data, isLoading, isError, error }`.

    **Mutation hooks:**
    Call all four mutation hooks at component top level:
    - `const createFactory = useCreateFactory()`
    - `const updateFactory = useUpdateFactory()`
    - `const deleteFactory = useDeleteFactory()`

    **Handler functions:**

    `handleCreate(formData: FactoryFormData)`:
    - Call `createFactory.mutateAsync({ organization_id: DEFAULT_ORG_ID, ...formData } as CreateFactoryInput)`
    - On success: `toast.success('Factory created successfully')`, close create dialog
    - On error: `toast.error('Failed to create factory')`, do NOT close dialog (let user retry)
    - Wrap in try/catch

    `handleUpdate(formData: FactoryFormData)`:
    - Guard: if `!editingFactory` return
    - Call `updateFactory.mutateAsync({ id: editingFactory.id, data: formData })`
    - On success: `toast.success('Factory updated successfully')`, clear editingFactory (closes dialog)
    - On error: `toast.error('Failed to update factory')`, do NOT close dialog
    - Wrap in try/catch

    `handleDelete()`:
    - Guard: if `!deletingFactory` return
    - Call `deleteFactory.mutateAsync(deletingFactory.id)`
    - On success: `toast.success('Factory deleted successfully')`, clear deletingFactory (closes dialog)
    - On error: `toast.error('Failed to delete factory')`, clear deletingFactory (close dialog even on error for deletes)
    - Wrap in try/catch

    **Render sections:**

    1. **Loading state (FACTORY-UI-06):** If `isLoading`, return a centered loading spinner using Loader2 icon with `animate-spin` class and "Loading factories..." text.

    2. **Error state:** If `isError`, return an error Card with red styling showing `error.message` and a "Try Again" button that calls `window.location.reload()`.

    3. **Page header:** Flex row with:
       - Left: h1 "Factories" (text-3xl font-bold) + subtitle "Manage your factory locations" (text-muted-foreground)
       - Right: "Add Factory" Button with Plus icon, onClick opens create dialog

    4. **Factory table (FACTORY-UI-01):** Wrapped in Card with CardHeader showing count (`{data.pagination.total} factory/factories`).
       - Table columns: Name, Location, Timezone, Created, Actions
       - **Empty state:** If `data.data.length === 0`, show TableRow with single TableCell (colSpan=5) containing centered message "No factories yet", subtitle "Create your first factory to get started.", and "Add Factory" Button
       - **Data rows:** Map `data.data` to TableRows:
         - Name: `font-medium`
         - Location: show value or em dash `â€”` if null/empty
         - Timezone: plain text
         - Created: format `created_at` with `new Date(factory.created_at).toLocaleDateString()`
         - Actions: two ghost Buttons -- Pencil icon (onClick sets editingFactory), Trash2 icon (onClick sets deletingFactory)

    5. **Create Dialog (FACTORY-UI-02):** Controlled Dialog (`open={isCreateDialogOpen}`, `onOpenChange={setIsCreateDialogOpen}`).
       - DialogHeader with title "Create Factory" and description "Add a new factory location to your organization."
       - Render `<FactoryForm onSubmit={handleCreate} isSubmitting={createFactory.isPending} submitLabel="Create Factory" />`

    6. **Edit Dialog (FACTORY-UI-03):** Controlled Dialog (`open={!!editingFactory}`, `onOpenChange={(open) => !open && setEditingFactory(null)}`).
       - DialogHeader with title "Edit Factory" and description "Update factory details."
       - Render `<FactoryForm defaultValues={editingFactory ? { name: editingFactory.name, location: editingFactory.location ?? '', timezone: editingFactory.timezone } : undefined} onSubmit={handleUpdate} isSubmitting={updateFactory.isPending} submitLabel="Save Changes" />`
       - IMPORTANT: Map `editingFactory` fields to FactoryFormData shape (location null -> empty string). Do NOT pass the entire Factory object as defaultValues -- FactoryForm expects `{ name, location, timezone }` only.

    7. **Delete AlertDialog (FACTORY-UI-04):** Controlled AlertDialog (`open={!!deletingFactory}`, `onOpenChange={(open) => !open && setDeletingFactory(null)}`).
       - AlertDialogHeader: title "Delete Factory", description 'Are you sure you want to delete "{deletingFactory?.name}"? This action cannot be undone.'
       - AlertDialogFooter: Cancel button + destructive Delete button
       - Delete button: `onClick={handleDelete}`, `disabled={deleteFactory.isPending}`, text shows "Deleting..." when pending
       - Style delete button with `className="bg-destructive text-destructive-foreground hover:bg-destructive/90"`

    **Key design decisions:**
    - Use `deletingFactory: Factory | null` (not just ID) so the delete dialog can show the factory name in the confirmation message
    - Page holds ONLY UI state (dialog open/close, selected item). All data state is in React Query.
    - Toast notifications use simple try/catch pattern (not promise toast) per research recommendation
    - No pagination UI for v1.1 (research says fetch all with default limit, most deployments have <20 factories)
    - No table sorting/filtering for v1.1 (deferred per research Open Question #3)
  </action>
  <verify>
    ```bash
    cd frontend && npx tsc --noEmit
    cd frontend && npm run build
    grep -c "useFactories\|useCreateFactory\|useUpdateFactory\|useDeleteFactory" frontend/src/pages/FactoriesPage.tsx
    grep -c "toast\.\(success\|error\)" frontend/src/pages/FactoriesPage.tsx
    grep -c "AlertDialog" frontend/src/pages/FactoriesPage.tsx
    grep -c "isLoading\|isPending" frontend/src/pages/FactoriesPage.tsx
    ```
    TypeScript compiles cleanly. Production build succeeds. All four CRUD hooks are imported and used. Toast calls exist for success/error. AlertDialog is used for delete confirmation. Loading states are handled.
  </verify>
  <done>
    FactoriesPage shows factory list in table (FACTORY-UI-01), create dialog with form validation (FACTORY-UI-02), edit dialog pre-populated (FACTORY-UI-03), delete confirmation AlertDialog (FACTORY-UI-04), toast notifications on all operations (FACTORY-UI-05), and loading states during fetch/submit (FACTORY-UI-06). TypeScript compiles with zero errors.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` - zero TypeScript errors
2. `cd frontend && npm run build` - production build succeeds
3. Verify FactoriesPage imports all 4 CRUD hooks from useFactories
4. Verify FactoriesPage imports and uses FactoryForm component
5. Verify toast.success and toast.error calls exist for create, update, and delete
6. Verify AlertDialog is used for delete confirmation (not browser confirm)
7. Verify loading state renders (Loader2 or similar) when isLoading is true
8. Verify isPending disables submit buttons during mutations
9. Verify empty state message renders when no factories exist
10. Verify DEFAULT_ORG_ID constant is used for create operations
</verification>

<success_criteria>
- FACTORY-UI-01: Factory list displays in table with Name, Location, Timezone, Created columns
- FACTORY-UI-02: Create factory opens Dialog with FactoryForm, validation errors show inline
- FACTORY-UI-03: Edit factory opens Dialog with pre-populated FactoryForm
- FACTORY-UI-04: Delete factory opens AlertDialog with factory name and Cancel/Delete buttons
- FACTORY-UI-05: toast.success on create/update/delete success, toast.error on failure
- FACTORY-UI-06: Loading spinner on initial fetch, disabled buttons with "Saving..."/"Deleting..." during mutations
- Zero TypeScript errors, production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/15-factory-management-ui/15-02-SUMMARY.md`
</output>
