---
phase: 09-api-server-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/api/config.ts
  - src/api/app.ts
  - src/api/plugins/cors.ts
  - src/api/plugins/helmet.ts
  - src/api/plugins/error-handler.ts
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Fastify instance creates successfully with Zod type provider"
    - "CORS headers are present on responses for configured origins"
    - "Security headers are present via Helmet middleware"
    - "Zod validation rejects invalid requests with detailed error messages"
    - "All errors return standardized JSON format with code, message, statusCode, and details"
    - "Request logging provides method, path, status, and duration"
  artifacts:
    - path: "src/api/config.ts"
      provides: "API server configuration with Zod validation"
      contains: "apiConfigSchema"
    - path: "src/api/app.ts"
      provides: "Fastify app factory with all plugins registered"
      exports: ["buildApp"]
    - path: "src/api/plugins/cors.ts"
      provides: "CORS plugin configuration"
    - path: "src/api/plugins/helmet.ts"
      provides: "Helmet security headers plugin"
    - path: "src/api/plugins/error-handler.ts"
      provides: "Standardized error response handler"
  key_links:
    - from: "src/api/app.ts"
      to: "src/api/plugins/cors.ts"
      via: "fastify.register()"
      pattern: "register.*cors"
    - from: "src/api/app.ts"
      to: "src/api/plugins/helmet.ts"
      via: "fastify.register()"
      pattern: "register.*helmet"
    - from: "src/api/app.ts"
      to: "src/api/plugins/error-handler.ts"
      via: "fastify.register()"
      pattern: "register.*error"
    - from: "src/api/app.ts"
      to: "fastify-type-provider-zod"
      via: "setValidatorCompiler + setSerializerCompiler"
      pattern: "setValidatorCompiler"
---

<objective>
Create the Fastify application factory with all cross-cutting plugins: Zod validation, CORS, Helmet security headers, standardized error handling, and environment-based logging.

Purpose: Establish the API server skeleton that Phases 10-11 will add routes to. All plugins must be registered before any routes, so this plan creates the complete app factory.
Output: `buildApp()` function that returns a fully-configured Fastify instance ready for route registration.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-api-server-foundation/09-RESEARCH.md

# Existing codebase patterns
@src/config.ts
@src/database/config.ts
@src/database/kysely.ts
@package.json
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create API configuration module</name>
  <files>
    package.json
    src/api/config.ts
    .env.example
  </files>
  <action>
    Install Fastify and plugins:
    ```bash
    npm install fastify fastify-type-provider-zod @fastify/cors @fastify/helmet
    npm install -D pino-pretty
    ```

    Create `src/api/config.ts` following the exact pattern from `src/database/config.ts` (Zod schema + parse + export):
    ```typescript
    import { z } from 'zod';

    const apiConfigSchema = z.object({
      API_PORT: z.coerce.number().default(3000),
      NODE_ENV: z.enum(['development', 'test', 'production']).default('development'),
      CORS_ORIGIN: z.string().default('*'),
      LOG_LEVEL: z.enum(['fatal', 'error', 'warn', 'info', 'debug', 'trace']).default('info'),
    });

    export type ApiConfig = z.infer<typeof apiConfigSchema>;
    export const apiConfig = apiConfigSchema.parse(process.env);
    ```

    Notes on config choices:
    - `API_PORT` defaults to 3000 per API-01 requirement
    - `NODE_ENV` controls logging format and CORS behavior
    - `CORS_ORIGIN` defaults to '*' for development (no frontend yet); in production, set to specific domain
    - `LOG_LEVEL` uses Pino's log levels (superset of existing LOG_LEVEL in src/config.ts)

    Append to `.env.example` under the existing Encryption section:
    ```
    # API Server (Milestone v1.0)
    API_PORT=3000
    NODE_ENV=development
    CORS_ORIGIN=*
    ```
  </action>
  <verify>
    - `npm ls fastify` shows fastify installed
    - `npm ls @fastify/cors @fastify/helmet fastify-type-provider-zod pino-pretty` shows all installed
    - `npx tsc --noEmit` compiles without errors
  </verify>
  <done>
    Fastify and all plugin dependencies installed. API config module validates environment variables at import time with sensible defaults. .env.example documents new variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create app factory with plugins and error handler</name>
  <files>
    src/api/app.ts
    src/api/plugins/cors.ts
    src/api/plugins/helmet.ts
    src/api/plugins/error-handler.ts
  </files>
  <action>
    Create `src/api/plugins/cors.ts`:
    - Export a Fastify plugin (using `fastify-plugin` to break encapsulation so CORS applies globally)
    - Import `apiConfig` from `../config`
    - In development/test: `origin: true` (reflect request origin) per research recommendation
    - In production: parse `CORS_ORIGIN` as comma-separated list of allowed origins
    - Always: `credentials: true`

    Create `src/api/plugins/helmet.ts`:
    - Export a Fastify plugin using `fastify-plugin`
    - Register `@fastify/helmet` with sensible defaults
    - Set `contentSecurityPolicy` to `false` for API-only server (no HTML responses, CSP not needed)
    - This is a REST API, not serving HTML — CSP headers would just add noise

    Create `src/api/plugins/error-handler.ts`:
    - Export a Fastify plugin using `fastify-plugin`
    - Call `fastify.setErrorHandler()` with a handler that:
      1. Extracts `statusCode` (from error.statusCode, default 500)
      2. Extracts `code` (from error.code, default 'INTERNAL_ERROR')
      3. Logs error with request context: `request.log.error({ err: error, statusCode, url: request.url, method: request.method })`
      4. For Zod validation errors (check `error.validation` exists): return 400 with `code: 'VALIDATION_ERROR'` and `details` array from `error.validation`
      5. For 500 errors: use generic message "Internal server error" (don't leak internals)
      6. Response format:
         ```json
         {
           "error": {
             "code": "VALIDATION_ERROR",
             "message": "Request validation failed",
             "statusCode": 400,
             "details": [...]
           }
         }
         ```
    - Also call `fastify.setNotFoundHandler()` to return 404 in standardized format:
      ```json
      {
        "error": {
          "code": "NOT_FOUND",
          "message": "Route GET /foo not found",
          "statusCode": 404
        }
      }
      ```

    Note: Install `fastify-plugin` as a dependency:
    ```bash
    npm install fastify-plugin
    ```

    Create `src/api/app.ts`:
    - Import `Fastify` from 'fastify'
    - Import `ZodTypeProvider` from 'fastify-type-provider-zod'
    - Import `serializerCompiler, validatorCompiler` from 'fastify-type-provider-zod'
    - Import `apiConfig` from './config'
    - Export `async function buildApp(options = {})`
    - Create Fastify instance with logger config:
      - `test` env: `logger: false`
      - `production` env: `{ level: apiConfig.LOG_LEVEL, redact: ['req.headers.authorization', 'req.body.password'] }`
      - `development` env: `{ level: 'debug', transport: { target: 'pino-pretty', options: { translateTime: 'HH:MM:ss.l', ignore: 'pid,hostname', colorize: true } } }`
    - Call `.withTypeProvider<ZodTypeProvider>()`
    - Set `app.setValidatorCompiler(validatorCompiler)` IMMEDIATELY (before any route registration — Pitfall 2 from research)
    - Set `app.setSerializerCompiler(serializerCompiler)` IMMEDIATELY
    - Register plugins in order: cors, helmet, error-handler
    - Return the app instance

    IMPORTANT: Do NOT register any routes in this plan. Routes come in Plan 02.
  </action>
  <verify>
    - `npx tsc --noEmit` compiles without errors
    - All 4 files exist: app.ts, plugins/cors.ts, plugins/helmet.ts, plugins/error-handler.ts
    - `app.ts` calls `setValidatorCompiler` before any `register` call
    - `error-handler.ts` handles both validation errors (400) and not-found (404)
  </verify>
  <done>
    App factory creates fully-configured Fastify instance with Zod validation, CORS, Helmet, and standardized error handling. All plugins use `fastify-plugin` for global scope. Logger configured per environment. Ready for route registration in Plan 02.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — TypeScript compiles with zero errors
2. All dependencies installed: `npm ls fastify @fastify/cors @fastify/helmet fastify-type-provider-zod fastify-plugin pino-pretty`
3. API config module exports `apiConfig` with `API_PORT`, `NODE_ENV`, `CORS_ORIGIN`, `LOG_LEVEL`
4. App factory exports `buildApp()` returning configured Fastify instance
5. Error handler produces `{ error: { code, message, statusCode, details? } }` format
</verification>

<success_criteria>
- `buildApp()` returns a Fastify instance with Zod type provider, CORS, Helmet, and error handling
- TypeScript compilation succeeds with strict mode
- All new files follow existing project patterns (Zod config, modular structure)
- .env.example updated with new API variables
</success_criteria>

<output>
After completion, create `.planning/phases/09-api-server-foundation/09-01-SUMMARY.md`
</output>
