---
phase: 01-foundation-and-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - .gitignore
  - .env.example
  - src/config.ts
  - src/utils/logger.ts
  - src/main.ts
  - src/types/index.ts
  - src/gateway/connection.ts
  - src/gateway/command-client.ts
  - src/gateway/notification-handler.ts
autonomous: true

must_haves:
  truths:
    - "npm run build completes with zero TypeScript errors"
    - "Running with valid env vars prints timestamped 'Application starting' log message"
    - "Running with missing GATEWAY_URL fails immediately with ZodError listing the missing field"
    - "Logger at info level suppresses debug messages but shows info/warn/error"
    - "Source files are organized into types/, gateway/, utils/, config.ts, main.ts"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with dependencies"
      contains: "zod"
    - path: "tsconfig.json"
      provides: "TypeScript strict mode configuration"
      contains: "strict"
    - path: "src/config.ts"
      provides: "Zod-validated config from environment variables"
      exports: ["config", "Config"]
    - path: "src/utils/logger.ts"
      provides: "Logger utility with timestamps and log levels"
      exports: ["Logger", "logger", "initLogger"]
    - path: "src/main.ts"
      provides: "Application entry point"
      min_lines: 10
    - path: "src/types/index.ts"
      provides: "Type definitions barrel export"
    - path: "src/gateway/connection.ts"
      provides: "Connection module placeholder"
    - path: "src/gateway/command-client.ts"
      provides: "Command client module placeholder"
    - path: "src/gateway/notification-handler.ts"
      provides: "Notification handler module placeholder"
  key_links:
    - from: "src/config.ts"
      to: "zod"
      via: "import { z } from 'zod' and configSchema.parse(process.env)"
      pattern: "z\\.object.*parse\\(process\\.env\\)"
    - from: "src/main.ts"
      to: "src/config.ts"
      via: "import config and use for logger initialization"
      pattern: "import.*config.*from.*config"
    - from: "src/main.ts"
      to: "src/utils/logger.ts"
      via: "import and initialize logger with config log level"
      pattern: "initLogger.*config\\.LOG_LEVEL"
    - from: "tsconfig.json"
      to: "TypeScript compiler"
      via: "strict: true enables all strict type checks"
      pattern: "\"strict\":\\s*true"
---

<objective>
Initialize the complete TypeScript project foundation: package.json with dependencies, TypeScript strict mode configuration, Zod-validated environment variable loading with fail-fast behavior, a simple logger utility with timestamps and configurable log levels, the full module directory structure (types/, gateway/, utils/), and a main.ts entry point that wires config to logger.

Purpose: This is the base layer every subsequent phase builds on. Phase 2 (Connection Management) needs the gateway/ module structure, config system, and logger. Getting this right means all future phases start from a working, buildable project.

Output: A buildable TypeScript project with `npm run build` succeeding, `npm run dev` executing main.ts, and configuration validation working end-to-end.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-configuration/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize TypeScript project with dependencies and directory structure</name>
  <files>
    package.json
    tsconfig.json
    .gitignore
    .env.example
    src/types/index.ts
    src/gateway/connection.ts
    src/gateway/command-client.ts
    src/gateway/notification-handler.ts
  </files>
  <action>
    1. Run `npm init -y` in the project root to create package.json.

    2. Install dependencies:
       ```
       npm install zod
       npm install -D typescript tsx @types/node
       ```

    3. Create tsconfig.json with TypeScript strict mode (TYPE-05). Use these exact settings from the research:
       ```json
       {
         "compilerOptions": {
           "target": "ES2020",
           "module": "commonjs",
           "moduleResolution": "node",
           "lib": ["ES2020"],
           "outDir": "./dist",
           "rootDir": "./src",
           "strict": true,
           "esModuleInterop": true,
           "skipLibCheck": true,
           "forceConsistentCasingInFileNames": true,
           "resolveJsonModule": true,
           "declaration": true,
           "declarationMap": true,
           "sourceMap": true,
           "noEmitOnError": true
         },
         "include": ["src/**/*"],
         "exclude": ["node_modules", "dist", "**/*.test.ts"]
       }
       ```

    4. Add npm scripts to package.json:
       - "build": "tsc"
       - "dev": "tsx src/main.ts"
       - "start": "node dist/main.js"

    5. Create .gitignore with: node_modules/, dist/, .env, *.js.map (in dist)

    6. Create .env.example with all environment variables documented (CFG-01, CFG-05):
       ```
       # Required
       GATEWAY_URL=ws://192.168.1.100:5000
       GATEWAY_EMAIL=user@example.com
       GATEWAY_PASSWORD=yourpassword
       SENSOR_SERIAL=12345

       # Optional (with defaults)
       CONNECTION_TIMEOUT=10000
       COMMAND_TIMEOUT=30000
       ACQUISITION_TIMEOUT=60000
       HEARTBEAT_INTERVAL=30000
       LOG_LEVEL=info
       ```

    7. Create module directory structure with stub files (CODE-01 through CODE-04):
       - src/types/index.ts: Empty barrel export file with comment "// Gateway API type definitions - populated in Phase 3"
       - src/gateway/connection.ts: Export placeholder comment "// WebSocket connection management - implemented in Phase 2"
       - src/gateway/command-client.ts: Export placeholder comment "// Command/response client - implemented in Phase 3"
       - src/gateway/notification-handler.ts: Export placeholder comment "// Notification handler - implemented in Phase 3"

       Each stub file should have a single-line placeholder export so TypeScript does not complain about empty modules:
       ```typescript
       // [description] - implemented in Phase N
       export {};
       ```

    Do NOT use dotenv package. The project will use Node.js native --env-file flag (Node 20.6+) as recommended by research. Document this in .env.example comments.
  </action>
  <verify>
    - `ls src/types/index.ts src/gateway/connection.ts src/gateway/command-client.ts src/gateway/notification-handler.ts` all exist
    - `cat package.json | grep zod` shows zod in dependencies
    - `cat tsconfig.json | grep strict` shows strict: true
    - `npx tsc --noEmit` succeeds with zero errors (on the stub files)
  </verify>
  <done>
    package.json exists with zod dependency and build/dev/start scripts. tsconfig.json has strict: true. All module directories (types/, gateway/, utils/) exist with stub files. .gitignore and .env.example are present. `npx tsc --noEmit` passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement config validation, logger utility, and main entry point</name>
  <files>
    src/config.ts
    src/utils/logger.ts
    src/main.ts
  </files>
  <action>
    1. Create src/config.ts implementing CFG-01 through CFG-05:
       - Import `z` from 'zod'
       - Define configSchema using z.object() with:
         - GATEWAY_URL: z.string().url() (required) -- note: ws:// URLs may not pass url() validation. Use z.string().min(1) with a .refine() that checks it starts with "ws://" or "wss://", OR just use z.string().min(1) and validate format manually. Test which approach works. The key is that GATEWAY_URL must be present and non-empty.
         - GATEWAY_EMAIL: z.string().email() (required)
         - GATEWAY_PASSWORD: z.string().min(1) (required)
         - SENSOR_SERIAL: z.string().min(1) (required)
         - CONNECTION_TIMEOUT: z.coerce.number().min(1000).default(10000)
         - COMMAND_TIMEOUT: z.coerce.number().min(1000).default(30000)
         - ACQUISITION_TIMEOUT: z.coerce.number().min(1000).default(60000)
         - HEARTBEAT_INTERVAL: z.coerce.number().min(1000).default(30000)
         - LOG_LEVEL: z.enum(['debug', 'info', 'warn', 'error']).default('info')
       - Use configSchema.parse(process.env) at module level for fail-fast (CFG-04)
       - Export `config` (the parsed object) and `Config` type (z.infer<typeof configSchema>)

       IMPORTANT: Zod's z.string().url() validates HTTP/HTTPS URLs but may reject ws:// URLs. Use z.string().startsWith('ws://').or(z.string().startsWith('wss://')) or a custom refinement instead. Example:
       ```typescript
       GATEWAY_URL: z.string().refine(
         (val) => val.startsWith('ws://') || val.startsWith('wss://'),
         { message: 'GATEWAY_URL must start with ws:// or wss://' }
       ),
       ```

    2. Create src/utils/logger.ts implementing CODE-05:
       - Define LogLevel type: 'debug' | 'info' | 'warn' | 'error'
       - Define LOG_LEVELS record mapping each level to a numeric priority (debug=0, info=1, warn=2, error=3)
       - Create Logger class with:
         - Constructor accepting LogLevel (default 'info')
         - Private shouldLog(level) method comparing numeric priorities
         - Private log(level, message, ...args) method that:
           - Checks shouldLog, returns if not
           - Formats: "YYYY-MM-DDTHH:mm:ss.sssZ [LEVEL] message"
           - Routes to console.error for 'error', console.warn for 'warn', console.log for others
         - Public debug/info/warn/error methods delegating to log()
       - Export Logger class
       - Export mutable `logger` variable (let, not const)
       - Export `initLogger(level: LogLevel)` function that creates and assigns the logger singleton

    3. Create src/main.ts as the application entry point:
       - Import config from './config' (this triggers fail-fast validation)
       - Import initLogger and logger from './utils/logger'
       - Call initLogger(config.LOG_LEVEL)
       - Log startup message: logger.info('Gateway Integration Spike starting')
       - Log config summary (without password): logger.debug showing gatewayUrl, sensorSerial, and timeout values
       - Add a placeholder comment: "// Gateway connection logic will be added in Phase 2"

    After creating all files, run `npm run build` to confirm everything compiles. Then test:
    - Create a temporary .env file with valid values, run `npm run dev` with --env-file flag, confirm output
    - Test fail-fast: run WITHOUT env file, confirm ZodError is thrown with descriptive message
    - Clean up temporary .env file after testing
  </action>
  <verify>
    - `npm run build` completes with exit code 0
    - `GATEWAY_URL=ws://192.168.1.1:5000 GATEWAY_EMAIL=test@test.com GATEWAY_PASSWORD=pass SENSOR_SERIAL=12345 npx tsx src/main.ts` prints timestamped "[INFO] Gateway Integration Spike starting"
    - `npx tsx src/main.ts` (no env vars) exits with ZodError mentioning required fields
    - `GATEWAY_URL=ws://192.168.1.1:5000 GATEWAY_EMAIL=test@test.com GATEWAY_PASSWORD=pass SENSOR_SERIAL=12345 LOG_LEVEL=error npx tsx src/main.ts` produces NO info-level output (logger suppresses it)
  </verify>
  <done>
    config.ts loads and validates all 9 environment variables using Zod with fail-fast behavior. logger.ts provides timestamped output with configurable log levels. main.ts wires config to logger and prints startup message. `npm run build` succeeds. Running with valid env vars shows output. Running without env vars fails immediately with clear error listing missing fields.
  </done>
</task>

</tasks>

<verification>
Run these checks to confirm the entire phase is complete:

1. **Build check:** `npm run build` exits 0 with compiled JS in dist/
2. **Config validation (happy path):** Run with all required env vars set -- application starts and logs
3. **Config validation (fail-fast):** Run with NO env vars -- ZodError thrown immediately listing missing fields
4. **Config validation (partial):** Run with only GATEWAY_URL set -- ZodError lists remaining missing fields
5. **Config defaults:** Run with required vars only -- timeouts default to 10000/30000/60000, log level defaults to 'info'
6. **Logger levels:** Run with LOG_LEVEL=debug -- debug messages appear. Run with LOG_LEVEL=error -- only errors appear
7. **Directory structure:** Confirm src/types/, src/gateway/, src/utils/ directories exist with stub files
8. **Strict mode:** Add a deliberate type error (e.g., `const x: number = "hello"`) to any file -- `npm run build` must fail
</verification>

<success_criteria>
- `npm run build` produces zero errors
- Configuration loads from environment variables and validates with Zod (CFG-01, CFG-02)
- Default timeout values are applied when not specified (CFG-03)
- Missing required config causes immediate failure with descriptive error (CFG-04)
- Optional overrides (timeouts, heartbeat, log level) work correctly (CFG-05)
- Logger outputs ISO-8601 timestamps with configurable levels (CODE-05)
- Source code organized into types/, gateway/, utils/, config.ts, main.ts (CODE-01)
- Gateway module stubs exist for connection, command-client, notification-handler (CODE-02, CODE-03, CODE-04)
- TypeScript strict mode enabled with all checks (TYPE-05)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-configuration/01-01-SUMMARY.md`
</output>
