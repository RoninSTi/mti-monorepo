---
phase: 14-api-integration-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/hooks/useGateways.ts
autonomous: true

must_haves:
  truths:
    - "useGateways() returns gateway list with optional factory_id filter"
    - "useGateway(id) returns single gateway by ID"
    - "useCreateGateway() mutation creates gateway and invalidates list cache"
    - "useUpdateGateway() mutation updates gateway with optimistic update and rollback"
    - "useDeleteGateway() mutation soft-deletes gateway and invalidates list cache"
  artifacts:
    - path: "frontend/src/hooks/useGateways.ts"
      provides: "Gateway CRUD hooks with query key factory"
      exports: ["gatewayKeys", "useGateways", "useGateway", "useCreateGateway", "useUpdateGateway", "useDeleteGateway"]
  key_links:
    - from: "frontend/src/hooks/useGateways.ts"
      to: "frontend/src/lib/api.ts"
      via: "api.get/post/put/delete calls"
      pattern: "api\\.(get|post|put|delete)"
    - from: "frontend/src/hooks/useGateways.ts"
      to: "frontend/src/types/api.ts"
      via: "TypeScript type imports"
      pattern: "import type.*from '@/types/api'"
---

<objective>
Create React Query custom hooks for gateway CRUD operations with factory filtering support.

Purpose: Provide a type-safe data layer that gateway UI pages (Phase 16) will consume. Gateway hooks support factory-based filtering (critical for the gateway management workflow) and optimistic updates for responsive UX.

Output: `hooks/useGateways.ts` with 5 exported hooks + query key factory.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@frontend/src/lib/api.ts
@frontend/src/types/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gateway CRUD hooks with query key factory and factory filtering</name>
  <files>frontend/src/hooks/useGateways.ts</files>
  <action>
Create `frontend/src/hooks/useGateways.ts` with the following exports:

**Query key factory** (`gatewayKeys`):
- `all`: `['gateways'] as const` - root key for all gateway queries
- `lists()`: `[...all, 'list']` - all list queries
- `list(filters)`: `[...lists(), filters]` - specific list with filters `{ factory_id?: string; limit?: number; offset?: number }`
- `details()`: `[...all, 'detail']` - all detail queries
- `detail(id)`: `[...details(), id]` - specific gateway by UUID

**Hooks:**

1. `useGateways(params?: { factory_id?: string; limit?: number; offset?: number })` - Returns `useQuery` result typed as `PaginatedResponse<Gateway>`. Build query string from params using URLSearchParams, including `factory_id` filter when present. Query key: `gatewayKeys.list(params || {})`. The factory_id in the query key is critical - it ensures changing the factory filter triggers a new fetch (avoids Pitfall 2 from research: stale query keys).

2. `useGateway(id: string)` - Returns `useQuery` result typed as `Gateway`. Use `enabled: !!id` to prevent fetching with empty string. Query key: `gatewayKeys.detail(id)`.

3. `useCreateGateway()` - Returns `useMutation` with `mutationFn` accepting `CreateGatewayInput`, posting to `/gateways`, typed response `Gateway`. On success: invalidate `gatewayKeys.lists()` (invalidates all list variants including factory-filtered lists).

4. `useUpdateGateway()` - Returns `useMutation` with `mutationFn` accepting `{ id: string; data: UpdateGatewayInput }`, PUT to `/gateways/${id}`. Implements full optimistic update pattern:
   - `onMutate`: Cancel queries for detail(id), snapshot previous, optimistically set new data with spread `{ ...previous, ...data, updated_at: new Date().toISOString() }`. Note: password field is NOT in Gateway type (per GATEWAY-07), so it won't appear in optimistic data.
   - `onError`: Rollback to snapshot
   - `onSettled`: Invalidate both `detail(id)` and `lists()` to sync with server

5. `useDeleteGateway()` - Returns `useMutation` with `mutationFn` accepting `id: string`, DELETE to `/gateways/${id}`. On success: invalidate `gatewayKeys.lists()`.

Import `useQuery`, `useMutation`, `useQueryClient` from `@tanstack/react-query`. Import `api` from `@/lib/api`. Import types from `@/types/api`.

Follow the exact patterns from 14-RESEARCH.md code examples. Do NOT add toast notifications (deferred to Phase 16).
  </action>
  <verify>
Run `cd frontend && npx tsc --noEmit` - zero TypeScript errors. Verify the file exports all 6 items: `gatewayKeys`, `useGateways`, `useGateway`, `useCreateGateway`, `useUpdateGateway`, `useDeleteGateway`.
  </verify>
  <done>
All 5 gateway hooks and the query key factory are exported, TypeScript compiles cleanly, hooks use correct API endpoints and types, factory_id filter included in query keys, optimistic update implemented on useUpdateGateway with onMutate/onError/onSettled pattern.
  </done>
</task>

</tasks>

<verification>
1. `cd frontend && npx tsc --noEmit` passes with zero errors
2. `frontend/src/hooks/useGateways.ts` exists and exports gatewayKeys, useGateways, useGateway, useCreateGateway, useUpdateGateway, useDeleteGateway
3. All hooks use correct API endpoints: `/gateways`, `/gateways/${id}`, `/gateways?factory_id=...`
4. useGateways includes factory_id in query key AND query string
5. Optimistic update on useUpdateGateway has onMutate, onError, and onSettled callbacks
</verification>

<success_criteria>
- Gateway CRUD hooks compile and export all 6 items
- Query key factory uses hierarchical array keys with factory_id filter support
- useGateways query key includes filter params (prevents stale data on filter change)
- useUpdateGateway implements snapshot-and-rollback optimistic update
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/14-api-integration-layer/14-02-SUMMARY.md`
</output>
