---
phase: 11-gateway-api-crud
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/api/routes/gateways.ts
  - src/api/app.ts
  - README.md
autonomous: true

must_haves:
  truths:
    - "POST /api/gateways creates a gateway with encrypted password and returns 201 without password in response"
    - "GET /api/gateways returns paginated list with pagination metadata"
    - "GET /api/gateways?factory_id=uuid filters gateways by factory"
    - "GET /api/gateways/:id returns a single gateway without password fields, or 404 if not found"
    - "PUT /api/gateways/:id updates gateway fields and re-encrypts password if changed, returns updated data or 404"
    - "DELETE /api/gateways/:id soft deletes and returns 204, or 404 if not found"
    - "Deleted gateways do not appear in GET /api/gateways or GET /api/gateways/:id"
    - "Invalid request bodies return 400 with VALIDATION_ERROR code and details"
    - "Database errors return 500 with safe error messages (no credential leakage)"
    - "README documents setup, configuration, and API usage for both Factory and Gateway endpoints"
  artifacts:
    - path: "src/api/routes/gateways.ts"
      provides: "All five CRUD route handlers for gateway management with password encryption"
      exports: ["default (FastifyPluginAsyncZod)"]
      min_lines: 120
    - path: "src/api/app.ts"
      provides: "Gateway routes registered with /api/gateways prefix"
      contains: "gateways"
    - path: "README.md"
      provides: "Project setup, configuration, and API usage documentation"
      contains: "Gateway"
  key_links:
    - from: "src/api/routes/gateways.ts"
      to: "src/api/schemas/gateways.ts"
      via: "imports Zod schemas for request/response validation"
      pattern: "import.*schemas/gateways"
    - from: "src/api/routes/gateways.ts"
      to: "src/repositories/GatewayRepository.ts"
      via: "imports gatewayRepository singleton for data access and encryption"
      pattern: "import.*gatewayRepository.*GatewayRepository"
    - from: "src/api/app.ts"
      to: "src/api/routes/gateways.ts"
      via: "registers gateway routes with prefix"
      pattern: "register.*routes/gateways.*prefix.*gateways"
---

<objective>
Implement all five gateway CRUD route handlers with encrypted password handling, register them with the Fastify application, and create project README documentation.

Purpose: Complete the Gateway API and the entire Milestone v1.0 by wiring Zod schemas (from Plan 01) to Fastify route handlers that delegate to GatewayRepository with transparent encryption. The README fulfills QUAL-07 by documenting setup and usage for the complete API.

Output: A complete gateway CRUD API accessible at /api/gateways with password encryption, factory filtering, and a comprehensive README.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-gateway-api-crud/11-RESEARCH.md
@.planning/phases/11-gateway-api-crud/11-01-SUMMARY.md

@src/api/app.ts
@src/api/routes/factories.ts
@src/api/routes/health.ts
@src/api/plugins/error-handler.ts
@src/api/schemas/common.ts
@src/api/schemas/gateways.ts
@src/repositories/GatewayRepository.ts
@src/repositories/types.ts
@package.json
@.env.example
@docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gateway CRUD route handlers</name>
  <files>src/api/routes/gateways.ts</files>
  <action>
Create `src/api/routes/gateways.ts` as a FastifyPluginAsyncZod plugin. Follow the same pattern as `src/api/routes/factories.ts`. Import schemas from `../schemas/gateways` and import `gatewayRepository` from `../../repositories/GatewayRepository`. Import the `Gateway` type from `../../repositories/types`.

**Create helper function `toGatewayResponse`** that converts a repository Gateway to API response:
- Include: id, factory_id, gateway_id, name, url, email, model, firmware_version, metadata, created_at, updated_at
- Convert Date fields to ISO strings: `created_at.toISOString()`, `updated_at.toISOString()`
- Handle nullable date: `last_seen_at ? last_seen_at.toISOString() : null`
- Cast metadata: `(gateway.metadata || {}) as Record<string, unknown>`
- **CRITICAL: Exclude password_encrypted** -- this field must NEVER appear in API responses (GATEWAY-07)
- **CRITICAL: Exclude deleted_at** -- internal implementation detail

Implement five route handlers:

**POST /** (Create gateway - GATEWAY-01, GATEWAY-06):
- Schema: body = createGatewaySchema, response 201 = gatewayResponseSchema
- Handler: Call `gatewayRepository.create(request.body as any)`. Repository encrypts password automatically.
- Return 201 with `toGatewayResponse(gateway)`
- Zod validation handles GATEWAY-09 automatically via error handler plugin

**GET /** (List gateways - GATEWAY-02):
- Schema: querystring = gatewayListQuerySchema, response 200 = gatewayListResponseSchema
- Handler: Extract `{ limit, offset, factory_id }` from `request.query`
- If `factory_id` is present:
  - Call `gatewayRepository.findActive(factory_id)` to get factory-filtered gateways
  - Set `total = factoryGateways.length`
  - Apply manual pagination: `gateways = factoryGateways.slice(offset, offset + limit)`
- If no `factory_id`:
  - Call `gatewayRepository.findAll({ limit, offset })` and `gatewayRepository.count()` in parallel with `Promise.all`
- Return `{ data: gateways.map(toGatewayResponse), pagination: { total, limit, offset, hasNext: offset + limit < total, hasPrev: offset > 0 } }`

**GET /:id** (Get gateway by ID - GATEWAY-03):
- Schema: params = z.object({ id: z.string().uuid() }), response 200 = gatewayResponseSchema
- Handler: Call `gatewayRepository.findById(request.params.id)`
- If undefined, return 404 with `{ error: { code: 'GATEWAY_NOT_FOUND', message: 'Gateway not found', statusCode: 404 } }`
- Use `(reply as any).code(404).send(...)` to handle type casting for non-200 responses (same pattern as factories.ts)
- Otherwise return `toGatewayResponse(gateway)`

**PUT /:id** (Update gateway - GATEWAY-04):
- Schema: params = z.object({ id: z.string().uuid() }), body = updateGatewaySchema, response 200 = gatewayResponseSchema
- Handler: Destructure `{ password, ...otherUpdates }` from `request.body`
- **If password is present:**
  1. Call `gatewayRepository.updatePassword(request.params.id, password)` to re-encrypt
  2. If result is undefined, return 404 GATEWAY_NOT_FOUND
  3. If `Object.keys(otherUpdates).length > 0`, also call `gatewayRepository.update(request.params.id, otherUpdates as any)` to update remaining fields
- **If password is NOT present:**
  1. Call `gatewayRepository.update(request.params.id, otherUpdates as any)` for other fields
  2. If result is undefined, return 404 GATEWAY_NOT_FOUND
- Return `toGatewayResponse(updated)`

**DELETE /:id** (Soft delete gateway - GATEWAY-05):
- Schema: params = z.object({ id: z.string().uuid() })
- Handler: Call `gatewayRepository.softDelete(request.params.id)`
- If undefined, return 404 with GATEWAY_NOT_FOUND error
- Otherwise return 204 with `reply.code(204).send()`

Export the plugin as default export.

**Important implementation notes:**
- Do NOT define response schema for 404 errors -- let the error handler format them
- Do NOT define response schema for 204 -- Fastify handles empty responses
- Database errors (e.g., foreign key violation on invalid factory_id) are caught by the error handler plugin and return 500 with safe messages (GATEWAY-08)
- The try/catch in the error handler plugin already prevents credential/encryption error leakage
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify the file exports a default FastifyPluginAsyncZod. Verify all five HTTP methods are defined (POST, GET, GET/:id, PUT/:id, DELETE/:id). Verify that the string "password_encrypted" does NOT appear in the toGatewayResponse function.
  </verify>
  <done>
Gateway routes file implements all five CRUD operations. Password is encrypted on create via repository. Password is re-encrypted on update only when password field is present. Response never includes password_encrypted (GATEWAY-07). Factory filtering works via factory_id query parameter. Error handling follows safe message patterns (GATEWAY-08). TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register gateway routes in app.ts</name>
  <files>src/api/app.ts</files>
  <action>
Add gateway route registration to `src/api/app.ts`. After the existing factory route registration line:

```typescript
await app.register(import('./routes/factories'), { prefix: '/api/factories' });
```

Add:

```typescript
await app.register(import('./routes/gateways'), { prefix: '/api/gateways' });
```

This registers all gateway routes under /api/gateways. The routes in gateways.ts define paths as `/` and `/:id`, and the prefix makes them `/api/gateways` and `/api/gateways/:id`.

Do NOT change any other lines in app.ts. Only add the single registration line.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify app.ts contains the gateway routes registration line with the '/api/gateways' prefix.
  </verify>
  <done>
Gateway routes registered at /api/gateways prefix. All five CRUD endpoints are accessible. App.ts has minimal change (one line added). Server builds without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create project README</name>
  <files>README.md</files>
  <action>
Create `README.md` at the project root. This fulfills requirement QUAL-07: README documents setup and usage.

The README should cover the following sections. Use the actual project details from package.json, .env.example, docker-compose.yml, and the API routes:

**Title and Description:**
- Project name: MTI WiFi Gateway Management System (or similar from project context)
- One-paragraph description: TypeScript/Node.js application for industrial vibration monitoring that manages factories, gateways, and sensor data collection via CTC Connect Wireless gateways
- Note that it provides a REST API for factory and gateway CRUD operations with encrypted credential storage

**Prerequisites:**
- Node.js 18+
- Docker and Docker Compose (for PostgreSQL)
- npm

**Getting Started / Setup:**
1. Clone the repository
2. Install dependencies: `npm install`
3. Start PostgreSQL: `npm run docker:up`
4. Copy environment config: `cp .env.example .env` (note: review and update values as needed)
5. Run database migrations: `npm run db:migrate`
6. Seed sample data: `npm run db:seed`
7. Start API server: `npm run dev:api`

**Configuration / Environment Variables:**
List the key environment variables from .env.example:
- DATABASE_URL - PostgreSQL connection string
- ENCRYPTION_KEY - AES-256 key for gateway password encryption (32-byte hex)
- API_PORT - Server port (default: 3000)
- NODE_ENV - Environment (development/production/test)
- CORS_ORIGIN - Allowed CORS origins
- LOG_LEVEL - Logging level

**Available Scripts:**
Table or list of npm scripts from package.json:
- `npm run dev:api` - Start API server in development mode
- `npm run dev` - Start gateway manager in development mode
- `npm run build` - Compile TypeScript
- `npm run start:api` - Start compiled API server
- `npm test` - Run tests
- `npm run db:migrate` - Run database migrations
- `npm run db:seed` - Seed sample data
- `npm run db:reset` - Reset database (drop and recreate)
- `npm run docker:up` - Start PostgreSQL container
- `npm run docker:down` - Stop PostgreSQL container
- `npm run docker:reset` - Reset PostgreSQL container (destroy data)

**API Endpoints:**
Document each endpoint with method, path, and brief description:

Health:
- GET /api/health - Health check (returns 200 with status info)

Factories:
- POST /api/factories - Create a factory
- GET /api/factories - List factories (paginated, query: limit, offset)
- GET /api/factories/:id - Get factory by ID
- PUT /api/factories/:id - Update factory
- DELETE /api/factories/:id - Soft delete factory

Gateways:
- POST /api/gateways - Create a gateway (password encrypted automatically)
- GET /api/gateways - List gateways (paginated, query: limit, offset, factory_id)
- GET /api/gateways/:id - Get gateway by ID
- PUT /api/gateways/:id - Update gateway (password re-encrypted if changed)
- DELETE /api/gateways/:id - Soft delete gateway

**Security Notes:**
- Gateway passwords are encrypted at rest using AES-256-GCM
- Passwords are never returned in API responses
- All API error responses use safe messages (no credential leakage)

**Project Structure:**
Brief overview of key directories:
- src/api/ - REST API server (Fastify)
- src/repositories/ - Data access layer (Kysely)
- src/database/ - Database configuration and migrations
- src/gateway/ - Gateway connection management (Milestone 0)
- src/utils/ - Shared utilities (encryption, etc.)
- migrations/ - Database migration files

Keep the README concise and practical. No badges, no contribution guidelines, no license section (not requested). Focus on what someone needs to set up and use the project.
  </action>
  <verify>
Verify README.md exists at the project root. Verify it contains sections for setup, environment variables, API endpoints (including gateway endpoints), and security notes about password encryption.
  </verify>
  <done>
README.md exists at project root with setup instructions, environment variable documentation, all API endpoint documentation (health, factories, gateways), security notes about password encryption, available scripts, and project structure overview. QUAL-07 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All five gateway routes are registered:
   - POST /api/gateways -> 201 with gateway data (no password in response)
   - GET /api/gateways -> 200 with paginated list (supports factory_id filter)
   - GET /api/gateways/:id -> 200 with gateway (no password) or 404
   - PUT /api/gateways/:id -> 200 with updated gateway (re-encrypts password if changed) or 404
   - DELETE /api/gateways/:id -> 204 or 404
3. No gateway API response contains password or password_encrypted fields
4. Invalid request bodies return 400 VALIDATION_ERROR (via Zod + error handler)
5. Non-UUID :id returns 400 (via Zod params validation)
6. Missing gateways return 404 GATEWAY_NOT_FOUND
7. Soft-deleted gateways do not appear in list or get-by-id queries
8. Pagination metadata (total, limit, offset, hasNext, hasPrev) is correct
9. Factory filtering returns only gateways for specified factory_id
10. README.md documents setup, configuration, and all API endpoints
</verification>

<success_criteria>
- All GATEWAY-01 through GATEWAY-09 requirements are satisfied
- QUAL-07 (README) is satisfied
- Gateway CRUD is fully functional via REST API with encrypted passwords
- Passwords never exposed in API responses
- Factory filtering works with factory_id query parameter
- Server compiles and starts without errors
- README provides complete setup and usage documentation
</success_criteria>

<output>
After completion, create `.planning/phases/11-gateway-api-crud/11-02-SUMMARY.md`
</output>
