---
phase: 11-gateway-api-crud
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/schemas/gateways.ts
  - src/repositories/GatewayRepository.ts
autonomous: true

must_haves:
  truths:
    - "Gateway create request validates factory_id (UUID), gateway_id, name, url, email, password (min 1 char), and optional fields"
    - "Gateway update request validates all fields as optional, including password"
    - "Gateway response schema excludes password and password_encrypted fields"
    - "Gateway list query supports optional factory_id filter in addition to pagination"
    - "GatewayRepository supports paginated queries with limit/offset"
    - "GatewayRepository provides count of non-deleted gateways"
  artifacts:
    - path: "src/api/schemas/gateways.ts"
      provides: "Create, update, response, and list Zod schemas for gateway endpoints"
      exports: ["createGatewaySchema", "updateGatewaySchema", "gatewayResponseSchema", "gatewayListQuerySchema", "gatewayListResponseSchema"]
    - path: "src/repositories/GatewayRepository.ts"
      provides: "Paginated findAll and count methods"
      contains: "findAll.*limit.*offset"
  key_links:
    - from: "src/api/schemas/gateways.ts"
      to: "src/api/schemas/common.ts"
      via: "imports paginationQuerySchema and paginationResponseSchema"
      pattern: "import.*pagination.*common"
    - from: "src/repositories/GatewayRepository.ts"
      to: "kysely"
      via: "limit/offset query methods and countAll"
      pattern: "\\.limit\\(.*\\.offset\\("
---

<objective>
Create Zod validation schemas for gateway API requests/responses and add pagination support to GatewayRepository.

Purpose: Establish the validation and data access foundation that gateway CRUD routes will consume. The gateway schemas mirror factory schemas but add critical differences: password field on input, password exclusion on output, and factory_id filter on list queries.

Output: Gateway-specific schema file with password handling and an enhanced GatewayRepository that supports paginated queries with total count.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-gateway-api-crud/11-RESEARCH.md

@src/api/schemas/common.ts
@src/api/schemas/factories.ts
@src/repositories/GatewayRepository.ts
@src/repositories/FactoryRepository.ts
@src/repositories/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas for gateway API</name>
  <files>src/api/schemas/gateways.ts</files>
  <action>
Create `src/api/schemas/gateways.ts` with gateway-specific schemas. Follow the same structure and style as `src/api/schemas/factories.ts`. Import z from 'zod' and import `paginationQuerySchema` and `paginationResponseSchema` from './common'.

Define the following schemas:

**createGatewaySchema** - z.object for POST /api/gateways request body:
- `factory_id`: z.string().uuid() (required - references parent factory)
- `gateway_id`: z.string().min(1).max(255) (required - gateway's own identifier)
- `name`: z.string().min(1).max(255) (required - display name)
- `url`: z.string().url().max(500) (required - WebSocket connection URL)
- `email`: z.string().email().max(255) (required - gateway login email)
- `password`: z.string().min(1) (required - plaintext, will be encrypted by repository)
- `model`: z.string().max(100).optional() (optional - hardware model)
- `firmware_version`: z.string().max(50).optional() (optional - firmware version)
- `metadata`: z.record(z.string(), z.unknown()).default({}) (optional - arbitrary key-value data)

**updateGatewaySchema** - z.object for PUT /api/gateways/:id request body:
- All fields optional. Same validation rules as create but with .optional() on each:
- `gateway_id`: z.string().min(1).max(255).optional()
- `name`: z.string().min(1).max(255).optional()
- `url`: z.string().url().max(500).optional()
- `email`: z.string().email().max(255).optional()
- `password`: z.string().min(1).optional() (if present, triggers re-encryption)
- `model`: z.string().max(100).optional()
- `firmware_version`: z.string().max(50).optional()
- `metadata`: z.record(z.string(), z.unknown()).optional()
- Note: factory_id is NOT updatable (same pattern as organization_id in factory update)

**gatewayResponseSchema** - z.object for individual gateway response:
- `id`: z.string().uuid()
- `factory_id`: z.string().uuid()
- `gateway_id`: z.string()
- `name`: z.string()
- `url`: z.string()
- `email`: z.string()
- **NO password field** (GATEWAY-07 security requirement)
- **NO password_encrypted field** (GATEWAY-07 security requirement)
- `model`: z.string().nullable()
- `firmware_version`: z.string().nullable()
- `last_seen_at`: z.string().datetime().nullable()
- `metadata`: z.record(z.string(), z.unknown())
- `created_at`: z.string().datetime()
- `updated_at`: z.string().datetime()
- **NO deleted_at** (internal implementation detail, same as factory pattern)

**gatewayListQuerySchema** - extends paginationQuerySchema with factory filter:
- Use `paginationQuerySchema.extend({ factory_id: z.string().uuid().optional() })`
- This adds optional factory_id UUID filter to the standard limit/offset pagination

**gatewayListResponseSchema** - z.object for paginated gateway list:
- `data`: z.array(gatewayResponseSchema)
- `pagination`: paginationResponseSchema

Add JSDoc comments explaining the purpose of each schema. Note the security-critical password exclusion in response schema comments.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify the file exports createGatewaySchema, updateGatewaySchema, gatewayResponseSchema, gatewayListQuerySchema, and gatewayListResponseSchema.
  </verify>
  <done>
Gateway schema file exists with all five schemas. Create schema accepts plaintext password. Update schema has all fields optional including password. Response schema excludes password and password_encrypted fields (GATEWAY-07). List query extends pagination with optional factory_id filter. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pagination support to GatewayRepository</name>
  <files>src/repositories/GatewayRepository.ts</files>
  <action>
Modify `GatewayRepository` to support pagination, following the same pattern as `FactoryRepository.findAll()` and `FactoryRepository.count()`.

**Update findAll()** to accept optional pagination parameters:

Change the existing `findAll()` method signature from:
```typescript
async findAll(): Promise<Gateway[]>
```
to:
```typescript
async findAll(options?: { limit?: number; offset?: number }): Promise<Gateway[]>
```

Add conditional limit/offset to the existing query chain (after `.orderBy('name', 'asc')`):
- If `options?.limit` is truthy, append `.limit(options.limit)`
- If `options?.offset` is truthy, append `.offset(options.offset)`

This is backward-compatible: callers without options get all non-deleted gateways ordered by name (same as before).

**Add count() method** for pagination metadata:

```typescript
async count(): Promise<number> {
  const result = await db
    .selectFrom('gateways')
    .select(db.fn.countAll().as('count'))
    .where('deleted_at', 'is', null)
    .executeTakeFirstOrThrow();

  return Number(result.count);
}
```

Place the count() method after softDelete() and before getDecryptedPassword(), following logical grouping (query methods together, mutation methods together, utility methods last).

Do NOT change any other methods in GatewayRepository. Only modify findAll() signature and add count().
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify the findAll method signature accepts optional pagination parameters. Verify the count method exists and returns a number.
  </verify>
  <done>
GatewayRepository.findAll() accepts optional { limit, offset } for pagination while remaining backward-compatible with existing callers. count() method returns total non-deleted gateways for pagination metadata. TypeScript compiles cleanly. Matches FactoryRepository pattern exactly.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `src/api/schemas/gateways.ts` exports createGatewaySchema, updateGatewaySchema, gatewayResponseSchema, gatewayListQuerySchema, gatewayListResponseSchema
3. `src/api/schemas/gateways.ts` does NOT contain "password" in gatewayResponseSchema field list
4. `src/repositories/GatewayRepository.ts` has findAll with optional pagination and count() method
5. No existing functionality broken (findAll without args still works)
</verification>

<success_criteria>
- Schema files exist and compile
- Gateway response schema excludes all password fields (GATEWAY-07)
- GatewayRepository supports paginated queries (GATEWAY-02)
- All existing code continues to work (backward compatible)
- Foundation ready for Plan 02 to build routes on top
</success_criteria>

<output>
After completion, create `.planning/phases/11-gateway-api-crud/11-01-SUMMARY.md`
</output>
