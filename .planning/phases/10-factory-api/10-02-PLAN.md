---
phase: 10-factory-api
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/api/routes/factories.ts
  - src/api/app.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/factories creates a factory and returns 201 with factory data"
    - "GET /api/factories returns paginated list with pagination metadata"
    - "GET /api/factories/:id returns a single factory or 404 if not found"
    - "PUT /api/factories/:id updates factory fields and returns updated data or 404"
    - "DELETE /api/factories/:id soft deletes and returns 204, or 404 if not found"
    - "Deleted factories do not appear in GET /api/factories or GET /api/factories/:id"
    - "Invalid request bodies return 400 with VALIDATION_ERROR code and details"
    - "Non-UUID :id parameters return 400 with validation error"
  artifacts:
    - path: "src/api/routes/factories.ts"
      provides: "All five CRUD route handlers for factory management"
      exports: ["default (FastifyPluginAsyncZod)"]
      min_lines: 80
    - path: "src/api/app.ts"
      provides: "Factory routes registered with /api/factories prefix"
      contains: "factories"
  key_links:
    - from: "src/api/routes/factories.ts"
      to: "src/api/schemas/factories.ts"
      via: "imports Zod schemas for request/response validation"
      pattern: "import.*schemas/factories"
    - from: "src/api/routes/factories.ts"
      to: "src/api/schemas/common.ts"
      via: "imports pagination query schema"
      pattern: "import.*schemas/common"
    - from: "src/api/routes/factories.ts"
      to: "src/repositories/FactoryRepository.ts"
      via: "imports factoryRepository singleton for data access"
      pattern: "import.*factoryRepository.*FactoryRepository"
    - from: "src/api/app.ts"
      to: "src/api/routes/factories.ts"
      via: "registers factory routes with prefix"
      pattern: "register.*routes/factories.*prefix.*factories"
---

<objective>
Implement all five factory CRUD route handlers and register them with the Fastify application.

Purpose: Complete the Factory API phase by wiring Zod schemas (from Plan 01) to Fastify route handlers that delegate to FactoryRepository. This delivers FACTORY-01 through FACTORY-08 requirements.

Output: A complete factory CRUD API accessible at /api/factories with proper validation, error handling, and pagination.
</objective>

<execution_context>
@/Users/craigcronin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/craigcronin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-factory-api/10-RESEARCH.md
@.planning/phases/10-factory-api/10-01-SUMMARY.md

@src/api/app.ts
@src/api/routes/health.ts
@src/api/plugins/error-handler.ts
@src/api/schemas/common.ts
@src/api/schemas/factories.ts
@src/repositories/FactoryRepository.ts
@src/repositories/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create factory CRUD route handlers</name>
  <files>src/api/routes/factories.ts</files>
  <action>
Create `src/api/routes/factories.ts` as a FastifyPluginAsyncZod plugin. Follow the same pattern as `src/api/routes/health.ts` for plugin structure. Import schemas from `../schemas/factories` and `../schemas/common`, and import `factoryRepository` from `../../repositories/FactoryRepository`.

Create a helper function `toFactoryResponse` that converts a repository Factory result to an API response by:
- Calling `.toISOString()` on `created_at` and `updated_at` Date fields
- Spreading all other fields (id, organization_id, name, location, timezone, metadata)
- Excluding `deleted_at` from the response

Implement five route handlers:

**POST /** (Create factory - FACTORY-01):
- Schema: body = createFactorySchema, response 201 = factoryResponseSchema
- Handler: Call `factoryRepository.create(request.body)`, return 201 with `toFactoryResponse(factory)`
- Zod validation handles FACTORY-07 automatically via error handler plugin

**GET /** (List factories - FACTORY-02):
- Schema: querystring = paginationQuerySchema, response 200 = factoryListResponseSchema
- Handler: Extract `{ limit, offset }` from `request.query`
- Call `factoryRepository.findAll({ limit, offset })` for paginated data
- Call `factoryRepository.count()` for total count
- Return `{ data: factories.map(toFactoryResponse), pagination: { total, limit, offset, hasNext: offset + limit < total, hasPrev: offset > 0 } }`
- FACTORY-06 is automatic: FactoryRepository excludes deleted records

**GET /:id** (Get factory by ID - FACTORY-03):
- Schema: params = z.object({ id: z.string().uuid() }), response 200 = factoryResponseSchema
- Handler: Call `factoryRepository.findById(request.params.id)`
- If undefined, return 404 with `{ error: { code: 'FACTORY_NOT_FOUND', message: 'Factory not found', statusCode: 404 } }`
- Otherwise return `toFactoryResponse(factory)` (FACTORY-08 handled)

**PUT /:id** (Update factory - FACTORY-04):
- Schema: params = z.object({ id: z.string().uuid() }), body = updateFactorySchema, response 200 = factoryResponseSchema
- Handler: Call `factoryRepository.update(request.params.id, request.body)`
- If undefined (not found or deleted), return 404 with FACTORY_NOT_FOUND error
- Otherwise return `toFactoryResponse(updated)`

**DELETE /:id** (Soft delete factory - FACTORY-05):
- Schema: params = z.object({ id: z.string().uuid() })
- Handler: Call `factoryRepository.softDelete(request.params.id)`
- If undefined (not found or already deleted), return 404 with FACTORY_NOT_FOUND error
- Otherwise return 204 with no body: `reply.status(204).send()`

Export the plugin as default export.

Important implementation notes:
- Do NOT define response schema for 404 errors — let the error handler format them
- Do NOT define response schema for 204 — Fastify handles empty responses
- Use `reply.status(201).send(...)` for POST (not default 200)
- Use `reply.status(204).send()` for DELETE (no body)
- The params z.string().uuid() validation handles FACTORY-07 for invalid UUID parameters
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify the file exports a default FastifyPluginAsyncZod. Verify all five HTTP methods are defined (POST, GET, GET/:id, PUT/:id, DELETE/:id).
  </verify>
  <done>
Factory routes file implements all five CRUD operations. Each route uses Zod schemas for input validation. 404 responses use consistent FACTORY_NOT_FOUND error code. Dates are serialized as ISO strings. Deleted records are excluded automatically by repository. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register factory routes in app.ts</name>
  <files>src/api/app.ts</files>
  <action>
Add factory route registration to `src/api/app.ts`. After the existing health route registration line:

```typescript
await app.register(import('./routes/health'), { prefix: '/api' });
```

Add:

```typescript
await app.register(import('./routes/factories'), { prefix: '/api/factories' });
```

This registers all factory routes under /api/factories. The routes in factories.ts define paths as `/` and `/:id`, and the prefix makes them `/api/factories` and `/api/factories/:id`.

Do NOT change any other lines in app.ts. Only add the single registration line.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors. Verify app.ts contains the factory routes registration. Start the API server with `npx tsx src/api/server.ts` (requires database running) or verify TypeScript compilation passes.
  </verify>
  <done>
Factory routes registered at /api/factories prefix. All five CRUD endpoints are accessible. App.ts has minimal change (one line added). Server builds without errors.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All five routes are registered:
   - POST /api/factories -> 201 with factory data
   - GET /api/factories -> 200 with paginated list
   - GET /api/factories/:id -> 200 with factory or 404
   - PUT /api/factories/:id -> 200 with updated factory or 404
   - DELETE /api/factories/:id -> 204 or 404
3. Invalid request bodies return 400 VALIDATION_ERROR (via Zod + error handler)
4. Non-UUID :id returns 400 (via Zod params validation)
5. Missing factories return 404 FACTORY_NOT_FOUND
6. Soft-deleted factories do not appear in list or get-by-id queries
7. Pagination metadata (total, limit, offset, hasNext, hasPrev) is correct
</verification>

<success_criteria>
- All FACTORY-01 through FACTORY-09 requirements are satisfied
- Factory CRUD is fully functional via REST API
- Validation errors return 400 with details
- Missing resources return 404 with FACTORY_NOT_FOUND code
- Pagination works with configurable limit/offset
- Server compiles and starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/10-factory-api/10-02-SUMMARY.md`
</output>
